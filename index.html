<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EterniTrack ‚Äî M&A Deal Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Manrope:wght@300;400;500;600;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f2f2ef;
  --bg2: #e8e8e3;
  --white: #ffffff;
  --surface: #f8f8f5;
  --border: #ddddd8;
  --border2: #c8c8c2;
  --ink: #1a2f4a;
  --ink2: #2c4a6e;
  --muted: #7a8a9a;
  --muted2: #aab5c0;
  --gold: #8aad7f;
  --gold-light: #b5d4a8;
  --gold-bg: #eef5ec;
  --navy: #1a2f4a;
  --navy-light: #e4eaf2;
  --green: #6a9e5f;
  --green-bg: #eef5ec;
  --red: #b83a3a;
  --red-bg: #fde8e8;
  --orange: #c47a2a;
  --orange-bg: #fdf0e0;
  --shadow-sm: 0 1px 4px rgba(26,47,74,0.06), 0 0 0 1px rgba(26,47,74,0.04);
  --shadow-md: 0 4px 16px rgba(26,47,74,0.09), 0 0 0 1px rgba(26,47,74,0.04);
  --shadow-lg: 0 12px 40px rgba(26,47,74,0.14), 0 0 0 1px rgba(26,47,74,0.04);
  --radius: 14px;
  --radius-sm: 8px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Manrope', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar {
  position: fixed;
  left: 0; top: 0; bottom: 0;
  width: 240px;
  background: #ffffff;
  border-right: 1px solid #e8edf5;
  display: flex;
  flex-direction: column;
  z-index: 50;
  box-shadow: 2px 0 16px rgba(26,47,74,0.06);
}

.sidebar-logo {
  padding: 26px 24px 18px;
  border-bottom: 1px solid #e8edf5;
}
.logo-mark {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}
.logo-gem {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px;
  box-shadow: 0 2px 8px rgba(184,134,58,0.3);
}
.logo-name {
  font-family: 'Manrope', sans-serif;
  font-size: 19px;
  font-weight: 700;
  letter-spacing: -0.4px;
  color: var(--ink);
}
.logo-tagline {
  font-size: 10px;
  color: #9aadbe;
  letter-spacing: 2px;
  text-transform: uppercase;
  font-family: 'DM Mono', monospace;
}

.sidebar-section {
  padding: 12px 12px 4px;
}
.sidebar-section-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: #aab8c8;
  padding: 0 12px;
  margin-bottom: 6px;
  font-family: 'DM Mono', monospace;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 13.5px;
  font-weight: 500;
  color: #5a7080;
  transition: all 0.15s;
  margin-bottom: 2px;
}
.nav-item:hover { background: #f0f4fa; color: var(--navy); }
.nav-item.active { background: var(--navy-light); color: var(--navy); font-weight: 600; }
.nav-item.active .nav-icon { color: var(--navy); }
.nav-icon { font-size: 15px; width: 20px; text-align: center; }
.nav-badge {
  margin-left: auto;
  background: #e4eaf2;
  color: var(--navy);
  font-size: 10px;
  font-weight: 700;
  border-radius: 10px;
  padding: 1px 6px;
  font-family: 'DM Mono', monospace;
}

.sidebar-collab {
  margin-top: auto;
  padding: 16px;
  border-top: 1px solid #e8edf5;
}
.collab-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: #aab8c8;
  margin-bottom: 10px;
  font-family: 'DM Mono', monospace;
}
.collab-users {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.collab-user {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12.5px;
}
.user-avatar {
  width: 28px; height: 28px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px;
  font-weight: 700;
  flex-shrink: 0;
}
.avatar-you { background: #eef5ec; color: #5a8a50; }
.avatar-boss { background: #e4eaf2; color: var(--navy); }
.user-info-name { font-weight: 600; color: var(--navy); }
.user-info-role { font-size: 10.5px; color: #8a9aaa; }
.user-online {
  margin-left: auto;
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 0 2px var(--white), 0 0 5px var(--green);
}

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.main {
  margin-left: 240px;
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.topbar {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 36px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky; top: 0; z-index: 40;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.page-title {
  font-family: 'Manrope', sans-serif;
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.3px;
}
.breadcrumb {
  font-size: 12px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}
.breadcrumb-sep { color: var(--muted2); }

.topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 9px 18px;
  border-radius: 9px;
  font-family: 'Manrope', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-ghost {
  background: transparent;
  border: 1.5px solid var(--border2);
  color: var(--ink2);
}
.btn-ghost:hover { border-color: var(--gold); color: var(--gold); background: var(--gold-bg); }
.btn-primary {
  background: var(--navy);
  color: #fff;
  box-shadow: 0 2px 8px rgba(26,47,74,0.2);
}
.btn-primary:hover { background: var(--ink2); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,47,74,0.3); }
.btn-gold {
  background: var(--gold);
  color: #fff;
  box-shadow: 0 2px 8px rgba(138,173,127,0.3);
}
.btn-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(138,173,127,0.4); background: var(--green); }
.btn-sm { padding: 7px 14px; font-size: 12px; }

/* ‚îÄ‚îÄ‚îÄ CONTENT AREA ‚îÄ‚îÄ‚îÄ */
.content {
  padding: 32px 36px;
  flex: 1;
}

/* ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ */
.view { display: none; }
.view.active { display: block; animation: fadeUp 0.35s ease; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ‚îÄ‚îÄ‚îÄ KPI BAR ‚îÄ‚îÄ‚îÄ */
.kpi-bar {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 28px;
}

.kpi-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.2s;
}
.kpi-card:hover { box-shadow: var(--shadow-md); }
.kpi-card::before {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 3px;
}
.kpi-gold::before { background: var(--gold); }
.kpi-navy::before { background: var(--navy); }
.kpi-green::before { background: linear-gradient(90deg, var(--green), #5bc48a); }
.kpi-red::before { background: var(--orange); }

.kpi-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--muted);
  margin-bottom: 10px;
  font-family: 'DM Mono', monospace;
}
.kpi-value {
  font-family: 'Manrope', sans-serif;
  font-size: 34px;
  font-weight: 700;
  line-height: 1;
  color: var(--ink);
}
.kpi-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}
.kpi-icon {
  position: absolute;
  right: 20px; top: 20px;
  font-size: 22px;
  opacity: 0.15;
}

/* ‚îÄ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ‚îÄ */
.section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}
.section-title {
  font-family: 'Manrope', sans-serif;
  font-size: 22px;
  font-weight: 700;
}
.section-count {
  font-size: 12px;
  color: var(--muted);
  background: var(--bg2);
  padding: 2px 10px;
  border-radius: 20px;
  margin-left: 10px;
  font-family: 'DM Mono', monospace;
}

/* ‚îÄ‚îÄ‚îÄ PROJECT CARDS ‚îÄ‚îÄ‚îÄ */
.projects-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(370px, 1fr));
  gap: 18px;
}

.project-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}
.project-card::after {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  border-radius: 4px 0 0 4px;
  background: var(--navy);
}

.project-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
  border-color: var(--border2);
}

.card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 16px;
}
.deal-badge {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 500;
}
.badge-acquisition { background: var(--navy-light); color: var(--navy); }
.badge-buyout { background: var(--navy-light); color: var(--navy); }
.badge-merger { background: var(--gold-bg); color: var(--gold); }
.badge-divestiture { background: var(--green-bg); color: var(--green); }
.badge-ipo { background: var(--red-bg); color: var(--red); }

.status-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  font-weight: 600;
  color: var(--muted);
}
.status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
}
.s-active .status-dot { background: var(--green); box-shadow: 0 0 4px var(--green); }
.s-closed .status-dot { background: var(--muted2); }
.s-pending .status-dot { background: var(--orange); box-shadow: 0 0 4px var(--orange); }
.s-active { color: var(--green); }
.s-pending { color: var(--orange); }

.card-name {
  font-family: 'Manrope', sans-serif;
  font-size: 21px;
  font-weight: 700;
  margin-bottom: 5px;
  line-height: 1.2;
}
.card-parties {
  font-size: 12.5px;
  color: var(--muted);
  margin-bottom: 18px;
}
.card-parties strong { color: var(--ink2); font-weight: 600; }

.card-metrics {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 18px;
  padding: 14px;
  background: var(--bg);
  border-radius: 10px;
}
.metric { }
.metric-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--muted2);
  margin-bottom: 4px;
  font-family: 'DM Mono', monospace;
}
.metric-val {
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  font-weight: 500;
  color: var(--ink);
}
.metric-val.gold { color: var(--gold); }

.card-progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 11.5px;
  color: var(--muted);
  margin-bottom: 6px;
}
.card-progress-label strong { color: var(--ink2); }
.progress-track {
  height: 5px;
  background: var(--bg2);
  border-radius: 3px;
  margin-bottom: 10px;
}
.progress-fill {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, var(--navy), var(--gold));
}

.phase-dots {
  display: flex;
  gap: 5px;
}
.pdot {
  flex: 1;
  height: 3px;
  border-radius: 2px;
  background: var(--bg2);
}
.pdot.done { background: var(--gold); }
.pdot.current { background: var(--navy); }

/* ‚îÄ‚îÄ‚îÄ RISK INDICATOR ‚îÄ‚îÄ‚îÄ */
.risk-tag {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 10.5px;
  font-weight: 600;
  padding: 3px 9px;
  border-radius: 6px;
  margin-top: 10px;
  font-family: 'DM Mono', monospace;
}
.risk-low { background: var(--green-bg); color: var(--green); }
.risk-medium { background: var(--orange-bg); color: var(--orange); }
.risk-high { background: var(--red-bg); color: var(--red); }

/* ‚îÄ‚îÄ‚îÄ GANTT / OVERVIEW ‚Äî CLEAN & SCROLLABLE ‚îÄ‚îÄ‚îÄ */
.gantt-fullscreen-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #fff;
  z-index: 500;
  flex-direction: column;
}
.gantt-fullscreen-overlay.open { display: flex; }

.gantt-container {
  background: #fff;
  border-radius: var(--radius);
  border: 1px solid #e4eaf2;
  box-shadow: 0 2px 16px rgba(26,47,74,0.06);
  display: flex;
  flex-direction: column;
}

.gantt-canvas {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
}

/* Top bar */
.gantt-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px 12px;
  border-bottom: 1px solid #edf2f7;
  flex-shrink: 0;
}
.gantt-topbar-title {
  font-family: 'Manrope', sans-serif;
  font-size: 15px;
  font-weight: 700;
  color: #1a2f4a;
}
.gantt-topbar-sub {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: #a0b4c8;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-top: 2px;
}
.gantt-topbar-actions { display: flex; gap: 8px; align-items: center; }

.gantt-legend {
  display: flex;
  gap: 16px;
  align-items: center;
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: #8a9aaa;
  letter-spacing: 0.5px;
}
.gantt-legend-item { display: flex; align-items: center; gap: 5px; }
.gl-pip {
  width: 6px; height: 6px; border-radius: 50%;
  flex-shrink: 0;
}
.gl-dd     { background: #93c5fd; }
.gl-signing { background: #fbbf24; }
.gl-closing { background: #4ade80; }
.gl-today-pip { width: 2px; height: 10px; background: #94a3b8; border-radius: 1px; }

.gantt-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 6px 12px;
  border-radius: 7px;
  font-family: 'Manrope', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid #dde8f0;
  background: #fff;
  color: #5a7090;
  transition: all 0.12s;
}
.gantt-btn:hover { background: #f4f8fc; color: #1a2f4a; }
.gantt-btn-primary { background: #1a2f4a; color: #fff; border-color: #1a2f4a; }
.gantt-btn-primary:hover { background: #253f60; }

.gantt-close-fs {
  display: flex; align-items: center; gap: 5px;
  padding: 6px 12px;
  border-radius: 7px;
  font-family: 'Manrope', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid #dde8f0;
  background: #fff;
  color: #5a7090;
  transition: all 0.12s;
}
.gantt-close-fs:hover { background: #f4f8fc; color: #1a2f4a; }

/* ‚îÄ‚îÄ CHART AREA: fixed label col + horizontally scrollable track ‚îÄ‚îÄ */
.gantt-chart-wrap {
  display: flex;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

/* Fixed left label column */
.gantt-label-pane {
  width: 180px;
  flex-shrink: 0;
  border-right: 1px solid #edf2f7;
  display: flex;
  flex-direction: column;
  background: #fff;
  z-index: 5;
}
.gantt-label-header {
  height: 44px;
  border-bottom: 1px solid #edf2f7;
  display: flex;
  align-items: center;
  padding: 0 16px;
  font-family: 'DM Mono', monospace;
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: #c0ccd8;
}
.gantt-label-rows {
  flex: 1;
  overflow: hidden;
}
.gantt-label-row {
  height: 56px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 0 16px;
  border-bottom: 1px solid #f4f7fb;
  cursor: pointer;
  transition: background 0.12s;
}
.gantt-label-row:hover { background: #f8fafd; }
.gantt-label-row:last-child { border-bottom: none; }
.gl-row-name {
  font-family: 'Manrope', sans-serif;
  font-size: 12px;
  font-weight: 700;
  color: #1a2f4a;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.gl-row-sub {
  font-size: 10px;
  color: #8a9aaa;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-family: 'DM Mono', monospace;
}
.gl-row-irr {
  font-size: 9px;
  font-family: 'DM Mono', monospace;
  font-weight: 700;
  color: #16a34a;
  margin-top: 2px;
}

/* Horizontally scrollable track pane */
.gantt-track-pane {
  flex: 1;
  overflow-x: auto;
  overflow-y: hidden;
  display: flex;
  flex-direction: column;
}
.gantt-track-pane::-webkit-scrollbar { height: 5px; }
.gantt-track-pane::-webkit-scrollbar-track { background: #f8fafc; }
.gantt-track-pane::-webkit-scrollbar-thumb { background: #c8d8e8; border-radius: 3px; }

/* The inner canvas ‚Äî wide enough for full time range */
.gantt-track-inner {
  flex: 1;
  display: flex;
  flex-direction: column;
  /* width set by JS */
}

/* Month header row */
.gantt-month-header {
  height: 44px;
  display: flex;
  align-items: flex-end;
  padding-bottom: 8px;
  border-bottom: 1px solid #edf2f7;
  flex-shrink: 0;
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 4;
}
.gantt-month-cell {
  position: absolute;
  bottom: 8px;
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  color: #b0bece;
  letter-spacing: 0.5px;
  white-space: nowrap;
  transform: translateX(-50%);
}
.gantt-month-cell.gmc-cur { color: #1a2f4a; font-weight: 700; }

/* Grid vertical lines */
.gantt-vgrid-line {
  position: absolute;
  top: 0; bottom: 0;
  width: 1px;
  background: #f0f4f9;
  pointer-events: none;
}
.gantt-vgrid-line.gvg-cur { background: rgba(26,47,74,0.08); }

/* Deal track rows */
.gantt-track-rows {
  flex: 1;
  position: relative;
}
.gantt-track-row {
  height: 56px;
  border-bottom: 1px solid #f4f7fb;
  position: relative;
}
.gantt-track-row:last-child { border-bottom: none; }

/* Today line */
.gantt-today-line {
  position: absolute;
  top: 0; bottom: 0;
  width: 1px;
  background: #94a3b8;
  opacity: 0.5;
  z-index: 8;
  pointer-events: none;
}
.gantt-today-pip {
  position: absolute;
  top: 4px;
  left: 4px;
  font-family: 'DM Mono', monospace;
  font-size: 8px;
  font-weight: 700;
  color: #64748b;
  letter-spacing: 1px;
  white-space: nowrap;
}

/* THE BAR ‚Äî slim and elegant */
.gd-bar {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  height: 22px;
  border-radius: 4px;
  cursor: pointer;
  transition: height 0.15s ease, opacity 0.15s;
  z-index: 3;
  display: flex;
  align-items: center;
  overflow: visible;
}
.gd-bar:hover { height: 28px; opacity: 0.92; z-index: 10; }

.gd-bar-body {
  position: absolute;
  inset: 0;
  border-radius: 4px;
  display: flex;
  align-items: center;
  padding: 0 8px;
  overflow: hidden;
}
.gd-bar-label {
  font-family: 'Manrope', sans-serif;
  font-size: 10px;
  font-weight: 700;
  color: rgba(255,255,255,0.95);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

/* DD stripe ‚Äî subtle pattern on bar */
.gd-dd-stripe {
  position: absolute;
  top: 0; bottom: 0;
  border-radius: 0;
  background: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 3px,
    rgba(255,255,255,0.18) 3px,
    rgba(255,255,255,0.18) 5px
  );
  pointer-events: none;
  z-index: 1;
}

/* Milestone pins ‚Äî tiny diamond/dot above bar */
.gd-pin {
  position: absolute;
  z-index: 15;
  display: flex;
  flex-direction: column;
  align-items: center;
  pointer-events: none;
  transform: translateX(-50%);
}
.gd-pin-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  border: 1.5px solid #fff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
  flex-shrink: 0;
}
.gd-pin-line {
  width: 1px;
  height: 6px;
  background: currentColor;
  opacity: 0.5;
}
.gd-pin-label {
  font-family: 'DM Mono', monospace;
  font-size: 8px;
  font-weight: 600;
  white-space: nowrap;
  margin-top: 2px;
  letter-spacing: 0.3px;
}
.gd-pin-dd    .gd-pin-dot { background: #60a5fa; color: #60a5fa; }
.gd-pin-dd    .gd-pin-label { color: #3b82f6; }
.gd-pin-loi   .gd-pin-dot { background: #c084fc; color: #c084fc; }
.gd-pin-loi   .gd-pin-label { color: #9333ea; }
.gd-pin-sign  .gd-pin-dot { background: #fbbf24; color: #fbbf24; }
.gd-pin-sign  .gd-pin-label { color: #d97706; }
.gd-pin-close .gd-pin-dot { background: #4ade80; color: #4ade80; }
.gd-pin-close .gd-pin-label { color: #16a34a; }

/* Bar color palette ‚Äî clean solids */
.gdc-1 .gd-bar-body { background: #1a2f4a; }
.gdc-2 .gd-bar-body { background: #166534; }
.gdc-3 .gd-bar-body { background: #92400e; }
.gdc-4 .gd-bar-body { background: #1e40af; }
.gdc-5 .gd-bar-body { background: #6b21a8; }

/* Hover tooltip */
.gd-tooltip {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  border: 1px solid #dde8f0;
  border-radius: 10px;
  padding: 14px;
  min-width: 240px;
  z-index: 100;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  box-shadow: 0 6px 24px rgba(26,47,74,0.12);
}
.gd-bar:hover .gd-tooltip { opacity: 1; }
.gd-tt-name { font-family: 'Manrope', sans-serif; font-size: 13px; font-weight: 700; color: #1a2f4a; margin-bottom: 2px; }
.gd-tt-co { font-size: 11px; color: #8a9aaa; margin-bottom: 10px; }
.gd-tt-row { display: flex; justify-content: space-between; align-items: baseline; padding: 4px 0; border-bottom: 1px solid #f0f4f9; font-size: 11px; }
.gd-tt-row:last-child { border-bottom: none; }
.gd-tt-k { color: #9aaabb; font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; }
.gd-tt-v { font-weight: 600; color: #1a2f4a; }
.gd-tt-v.g { color: #16a34a; }


/* ‚îÄ‚îÄ‚îÄ DETAIL VIEW ‚îÄ‚îÄ‚îÄ */
.detail-page {}
.detail-top {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 32px;
}
.detail-title-block { flex: 1; }
.detail-big-title {
  font-family: 'Manrope', sans-serif;
  font-size: 38px;
  font-weight: 700;
  letter-spacing: -1px;
  margin-bottom: 6px;
}
.detail-subtitle {
  font-size: 14px;
  color: var(--muted);
}

.detail-layout {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 24px;
}

.info-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  margin-bottom: 16px;
}
.info-card-title {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--muted);
  margin-bottom: 16px;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13.5px;
}
.detail-row:last-child { border-bottom: none; }
.dr-label { color: var(--muted); }
.dr-val { font-weight: 600; }
.dr-val.gold { color: var(--gold); font-family: 'DM Mono', monospace; }

/* VERTICAL TIMELINE */
.vt-phase {
  display: flex;
  gap: 20px;
  margin-bottom: 4px;
}
.vt-col {
  width: 44px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.vt-node {
  width: 40px; height: 40px;
  border-radius: 11px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
  border: 2px solid transparent;
  transition: all 0.2s;
  position: relative;
  z-index: 2;
}
.ph-done .vt-node { background: var(--gold-bg); border-color: var(--gold); }
.ph-current .vt-node { background: var(--navy-light); border-color: var(--navy); box-shadow: 0 0 0 4px rgba(30,53,87,0.1); animation: ring-pulse 2s infinite; }
.ph-future .vt-node { background: var(--bg); border-color: var(--border2); }
@keyframes ring-pulse {
  0%,100% { box-shadow: 0 0 0 4px rgba(30,53,87,0.08); }
  50% { box-shadow: 0 0 0 8px rgba(30,53,87,0.04); }
}

.vt-line {
  width: 2px;
  flex: 1;
  min-height: 24px;
  margin: 4px 0;
}
.ph-done .vt-line { background: linear-gradient(180deg, var(--gold), rgba(184,134,58,0.2)); }
.ph-current .vt-line { background: linear-gradient(180deg, var(--navy), rgba(30,53,87,0)); }
.ph-future .vt-line { background: var(--border); }

.vt-content {
  flex: 1;
  padding-bottom: 28px;
}
.vt-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 8px;
  margin-bottom: 10px;
}
.vt-title {
  font-size: 15px;
  font-weight: 600;
}
.ph-done .vt-title { color: var(--gold); }
.ph-current .vt-title { color: var(--navy); }
.ph-future .vt-title { color: var(--muted); }
.vt-date {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted2);
}
.vt-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
}
.ph-current .vt-card { border-color: rgba(30,53,87,0.2); background: var(--navy-light); }
.vt-desc { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 12px; }
.task-item {
  display: flex; align-items: center; gap: 9px;
  font-size: 12.5px; margin-bottom: 7px;
}
.task-box {
  width: 16px; height: 16px;
  border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px;
  flex-shrink: 0;
}
.t-done .task-box { background: var(--gold-bg); color: var(--gold); border: 1px solid rgba(184,134,58,0.3); }
.t-pending .task-box { border: 1.5px solid var(--border2); }
.t-done .task-lbl { color: var(--muted2); text-decoration: line-through; }
.t-pending .task-lbl { color: var(--ink2); }

/* ‚îÄ‚îÄ‚îÄ ACTIVITY FEED ‚îÄ‚îÄ‚îÄ */
.activity-item {
  display: flex;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12.5px;
}
.activity-item:last-child { border-bottom: none; }
.act-avatar {
  width: 26px; height: 26px;
  border-radius: 7px;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px;
  font-weight: 700;
}
.act-text { color: var(--ink2); line-height: 1.5; }
.act-text strong { color: var(--ink); }
.act-time {
  margin-left: auto;
  color: var(--muted2);
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  white-space: nowrap;
}

/* ‚îÄ‚îÄ‚îÄ RISK MATRIX ‚îÄ‚îÄ‚îÄ */
.risk-matrix {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.risk-item {
  padding: 12px;
  border-radius: 9px;
  font-size: 12.5px;
}
.ri-low { background: var(--green-bg); }
.ri-medium { background: var(--orange-bg); }
.ri-high { background: var(--red-bg); }
.ri-label {
  font-weight: 600;
  margin-bottom: 3px;
}
.ri-low .ri-label { color: var(--green); }
.ri-medium .ri-label { color: var(--orange); }
.ri-high .ri-label { color: var(--red); }
.ri-desc { color: var(--muted); font-size: 11.5px; }

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(26,24,20,0.45);
  backdrop-filter: blur(5px);
  z-index: 200;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
.overlay.open { opacity: 1; pointer-events: all; }
.modal-box {
  background: var(--white);
  border-radius: 20px;
  padding: 36px;
  width: 580px;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg), 0 0 0 1px rgba(0,0,0,0.06);
  transform: scale(0.96) translateY(12px);
  transition: transform 0.25s;
}
.overlay.open .modal-box { transform: scale(1) translateY(0); }
.modal-title {
  font-family: 'Manrope', sans-serif;
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 6px;
}
.modal-sub { font-size: 13px; color: var(--muted); margin-bottom: 28px; }
.form-group { margin-bottom: 16px; }
.form-label {
  display: block;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--muted);
  margin-bottom: 7px;
  font-family: 'DM Mono', monospace;
}
.form-input, .form-select, .form-textarea {
  width: 100%;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 9px;
  padding: 11px 14px;
  color: var(--ink);
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  appearance: none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--navy);
  box-shadow: 0 0 0 3px rgba(30,53,87,0.08);
  background: var(--white);
}
.form-textarea { resize: vertical; min-height: 80px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.modal-footer {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 28px;
  padding-top: 22px;
  border-top: 1px solid var(--border);
}

/* ‚îÄ‚îÄ‚îÄ EXPORT MODAL ‚îÄ‚îÄ‚îÄ */
.export-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 24px;
}
.export-opt {
  padding: 16px;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}
.export-opt:hover { border-color: var(--navy); background: var(--navy-light); }
.export-opt.sel { border-color: var(--navy); background: var(--navy-light); }
.exp-icon { font-size: 26px; margin-bottom: 8px; }
.exp-name { font-weight: 600; font-size: 13px; }
.exp-desc { font-size: 11px; color: var(--muted); margin-top: 3px; }

/* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
footer {
  margin-left: 240px;
  background: var(--white);
  border-top: 1px solid var(--border);
  padding: 16px 36px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.footer-brand {
  font-family: 'Manrope', sans-serif;
  font-size: 15px;
  color: var(--muted);
}
.footer-brand strong { color: var(--ink); }
.footer-credit {
  font-size: 11.5px;
  color: var(--muted2);
  font-family: 'DM Mono', monospace;
}
.footer-credit span { color: var(--gold); }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state {
  text-align: center;
  padding: 80px 20px;
}
.empty-icon { font-size: 40px; margin-bottom: 16px; }
.empty-title { font-family: 'Manrope', sans-serif; font-size: 24px; font-weight: 700; margin-bottom: 8px; }
.empty-sub { font-size: 14px; color: var(--muted); }

/* ‚îÄ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ */
.note-item {
  padding: 14px;
  background: var(--bg);
  border-radius: 9px;
  margin-bottom: 10px;
  border-left: 3px solid var(--gold);
}
.note-meta { font-size: 11px; color: var(--muted); margin-bottom: 5px; font-family: 'DM Mono', monospace; }
.note-text { font-size: 13px; color: var(--ink2); line-height: 1.5; }

/* ‚îÄ‚îÄ‚îÄ CHECKLIST VIEW ‚îÄ‚îÄ‚îÄ */
.checklist-section { margin-bottom: 24px; }
.cs-title {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.cs-pct {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--gold);
}

/* ‚îÄ‚îÄ‚îÄ LOGIN OVERLAY ‚îÄ‚îÄ‚îÄ */
#login-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
}
.login-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 48px 44px;
  width: 100%;
  max-width: 420px;
  box-shadow: var(--shadow-lg);
}
.login-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 32px;
}
.login-title {
  font-family: 'Manrope', sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--ink);
  margin-bottom: 6px;
  letter-spacing: -0.5px;
}
.login-sub {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 28px;
}
.login-field { margin-bottom: 16px; }
.login-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--muted);
  margin-bottom: 6px;
  display: block;
  font-family: 'DM Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 1.5px;
}
.login-input {
  width: 100%;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  color: var(--ink);
  background: var(--surface);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.login-input:focus {
  border-color: var(--navy);
  box-shadow: 0 0 0 3px rgba(26,47,74,0.08);
  background: var(--white);
}
.login-error {
  background: var(--red-bg);
  color: var(--red);
  font-size: 12.5px;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  display: none;
  font-weight: 500;
  border: 1px solid rgba(184,58,58,0.15);
}
.login-btn {
  width: 100%;
  padding: 12px;
  background: var(--navy);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
  margin-top: 4px;
  letter-spacing: 0.2px;
}
.login-btn:hover { background: #253f60; }
.login-footer-note {
  text-align: center;
  margin-top: 20px;
  font-size: 11px;
  color: var(--muted2);
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.5px;
}
.logout-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  width: calc(100% - 24px);
  margin: 8px 12px 12px;
  padding: 9px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--muted);
  font-family: 'Manrope', sans-serif;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  text-align: left;
}
.logout-btn:hover { background: var(--red-bg); color: var(--red); border-color: rgba(184,58,58,0.25); }
.logout-user {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--muted2);
  padding: 0 12px 4px;
  letter-spacing: 0.5px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* PRINT STYLES */
@media print {
  .sidebar, .topbar, footer, .btn, .topbar-right { display: none !important; }
  .main { margin-left: 0; }
  .content { padding: 0; }
  body { background: white; }
}

/* TOOLTIP */
.tooltip-wrap { position: relative; display: inline-block; }
.tooltip-box {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%; transform: translateX(-50%);
  background: var(--ink);
  color: #fff;
  font-size: 11px;
  padding: 5px 10px;
  border-radius: 6px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  font-family: 'DM Mono', monospace;
}
.tooltip-wrap:hover .tooltip-box { opacity: 1; }

/* COLLAB BADGE */
.collab-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--gold-bg);
  color: var(--green);
  font-size: 11px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
  font-family: 'DM Mono', monospace;
  margin-left: 8px;
}
.cb-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 4px var(--green);
}


/* ‚îÄ‚îÄ‚îÄ PIPEDRIVE SYNC ‚îÄ‚îÄ‚îÄ */
.pd-status-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 13px;
  font-weight: 500;
}
.pd-connected { background: var(--green-bg); color: var(--green); border: 1px solid rgba(45,122,82,0.2); }
.pd-disconnected { background: var(--bg2); color: var(--muted); border: 1px solid var(--border); }
.pd-error { background: var(--red-bg); color: var(--red); border: 1px solid rgba(184,58,58,0.2); }
.pd-loading { background: var(--navy-light); color: var(--navy); border: 1px solid rgba(30,53,87,0.2); }
.pd-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.pd-dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
.pd-dot-grey { background: var(--muted2); }
.pd-dot-red { background: var(--red); }
.pd-dot-pulse { background: var(--navy); animation: pd-pulse 1s infinite; }
@keyframes pd-pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

.stage-list { display: flex; flex-direction: column; gap: 8px; max-height: 260px; overflow-y: auto; }
.stage-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  cursor: pointer;
  transition: all 0.15s;
  font-size: 13px;
}
.stage-item:hover { border-color: var(--navy); background: var(--navy-light); }
.stage-item.selected { border-color: var(--navy); background: var(--navy-light); }
.stage-checkbox {
  width: 17px; height: 17px;
  border-radius: 5px;
  border: 2px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-size: 10px;
  transition: all 0.15s;
}
.stage-item.selected .stage-checkbox { background: var(--navy); border-color: var(--navy); color: #fff; }
.stage-name { font-weight: 500; flex: 1; }
.stage-count { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; }

.sync-preview {
  background: var(--bg);
  border-radius: 10px;
  padding: 14px;
  margin-top: 16px;
  max-height: 200px;
  overflow-y: auto;
}
.sync-preview-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--muted);
  margin-bottom: 10px;
  font-family: 'DM Mono', monospace;
}
.preview-deal {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12.5px;
}
.preview-deal:last-child { border-bottom: none; }
.preview-deal-name { font-weight: 600; flex: 1; }
.preview-deal-val { color: var(--gold); font-family: 'DM Mono', monospace; font-size: 11px; }
.preview-deal-stage { font-size: 11px; color: var(--muted); }
.preview-new { color: var(--green); font-size: 10px; font-weight: 700; font-family: 'DM Mono', monospace; }
.preview-exists { color: var(--muted2); font-size: 10px; font-family: 'DM Mono', monospace; }

.sync-spinner {
  display: inline-block;
  width: 14px; height: 14px;
  border: 2px solid rgba(30,53,87,0.2);
  border-top-color: var(--navy);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

.pd-last-sync {
  font-size: 11px;
  color: var(--muted2);
  font-family: 'DM Mono', monospace;
  margin-top: 6px;
}

</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
  <div class="login-card">
    <div class="login-logo">
      <div style="width:40px;height:40px;background:#1a2f4a;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(26,47,74,0.2);">
        <svg width="26" height="16" viewBox="0 0 26 16" fill="none">
          <path d="M6.5 8C6.5 5.5 8.3 3.5 10.5 3.5C12.2 3.5 13.5 4.8 14 6.5C14.5 4.8 15.8 3.5 17.5 3.5C19.7 3.5 21.5 5.5 21.5 8C21.5 10.5 19.7 12.5 17.5 12.5C15.8 12.5 14.5 11.2 14 9.5C13.5 11.2 12.2 12.5 10.5 12.5C8.3 12.5 6.5 10.5 6.5 8Z" stroke="#8aad7f" stroke-width="1.8" fill="none"/>
          <circle cx="14" cy="8" r="1.2" fill="#8aad7f" opacity="0.7"/>
        </svg>
      </div>
      <div>
        <div style="font-family:'Manrope',sans-serif;font-size:17px;font-weight:700;letter-spacing:-0.3px;line-height:1.1;">
          <span style="color:#1a2f4a;">eterni</span><span style="color:#8aad7f;">team</span>
        </div>
        <div style="font-family:'Manrope',sans-serif;font-size:10px;color:#aab8c8;letter-spacing:0.5px;margin-top:2px;font-weight:500;">Deal Tracker</div>
      </div>
    </div>
    <div class="login-title">Willkommen zur√ºck</div>
    <div class="login-sub">Melde dich mit deiner EterniTeam-E-Mail und dem Team-Passwort an.</div>
    <div id="login-error" class="login-error"></div>
    <div class="login-field">
      <label class="login-label" for="login-email">E-Mail</label>
      <input class="login-input" type="email" id="login-email" placeholder="name@eterniteam.de" autocomplete="email">
    </div>
    <div class="login-field">
      <label class="login-label" for="login-password">Passwort</label>
      <input class="login-input" type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="login-btn" onclick="doLogin()">Anmelden ‚Üí</button>
    <div class="login-footer-note">Nur f√ºr @eterniteam.de Mitglieder zug√§nglich</div>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">
      <!-- EterniTeam infinity logo recreation -->
      <div style="width:38px;height:38px;background:#1a2f4a;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(26,47,74,0.2);">
        <svg width="26" height="16" viewBox="0 0 26 16" fill="none">
          <!-- Left loop of infinity -->
          <path d="M6.5 8C6.5 5.5 8.3 3.5 10.5 3.5C12.2 3.5 13.5 4.8 14 6.5C14.5 4.8 15.8 3.5 17.5 3.5C19.7 3.5 21.5 5.5 21.5 8C21.5 10.5 19.7 12.5 17.5 12.5C15.8 12.5 14.5 11.2 14 9.5C13.5 11.2 12.2 12.5 10.5 12.5C8.3 12.5 6.5 10.5 6.5 8Z" stroke="#8aad7f" stroke-width="1.8" fill="none"/>
          <!-- Inner crossing line dots -->
          <circle cx="14" cy="8" r="1.2" fill="#8aad7f" opacity="0.7"/>
        </svg>
      </div>
      <div>
        <div style="font-family:'Manrope',sans-serif;font-size:16px;font-weight:700;letter-spacing:-0.3px;line-height:1.1;">
          <span style="color:#1a2f4a;">eterni</span><span style="color:#8aad7f;">team</span>
        </div>
        <div style="font-family:'Manrope',sans-serif;font-size:10px;color:#aab8c8;letter-spacing:0.5px;margin-top:2px;font-weight:500;">Deal Tracker</div>
      </div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-label">Workspace</div>
    <div class="nav-item active" onclick="switchNav('dashboard',this)">
      <span class="nav-icon">‚óà</span> Dashboard
    </div>
    <div class="nav-item" onclick="switchNav('projects',this)">
      <span class="nav-icon">‚óâ</span> Alle Deals
      <span class="nav-badge" id="nav-badge">0</span>
    </div>
    <div class="nav-item" onclick="switchNav('overview',this)">
      <span class="nav-icon">‚ñ¶</span> Gantt-Ansicht
    </div>
    <div class="nav-item" onclick="switchNav('checklist',this)">
      <span class="nav-icon">‚ú¶</span> Checklisten
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-label">Tools</div>
    <div class="nav-item" onclick="openPipedriveModal()">
      <span class="nav-icon">‚áÑ</span> Pipedrive Sync
      <span class="nav-badge" id="pd-badge" style="display:none;background:var(--green);">‚óè</span>
    </div>
    <div class="nav-item" onclick="openExportModal()">
      <span class="nav-icon">‚Üó</span> Export
    </div>
    <div class="nav-item" onclick="openModal()">
      <span class="nav-icon">Ôºã</span> Neuer Deal
    </div>
  </div>

  <div style="flex:1;"></div>
  <div id="logout-user-display" class="logout-user"></div>
  <button class="logout-btn" onclick="doLogout()">‚éã Abmelden</button>

  <div class="sidebar-collab">
    <div class="collab-title">Team ‚Äî Live</div>
    <div class="collab-users">
      <div class="collab-user">
        <div class="user-avatar avatar-you">YN</div>
        <div class="user-info">
          <div class="user-info-name">Yannick</div>
          <div class="user-info-role">Analyst</div>
        </div>
        <div class="user-online"></div>
      </div>
      <div class="collab-user">
        <div class="user-avatar avatar-boss">CH</div>
        <div class="user-info">
          <div class="user-info-name" id="boss-name">Chef</div>
          <div class="user-info-role">Managing Director</div>
        </div>
        <div class="user-online" id="boss-online" style="background:var(--muted2);box-shadow:none;"></div>
      </div>
    </div>
  </div>
</aside>

<!-- TOPBAR -->
<div style="margin-left:240px;display:flex;flex-direction:column;flex:1;">
<div class="topbar">
  <div class="topbar-left">
    <div>
      <div class="page-title" id="page-title">Dashboard</div>
      <div class="breadcrumb">
        <span>EterniTeam GmbH</span>
        <span class="breadcrumb-sep">‚Ä∫</span>
        <span id="breadcrumb-sub">√úbersicht</span>
      </div>
    </div>
    <div class="collab-badge" id="collab-indicator">
      <div class="cb-dot"></div>
      <span>2 Online</span>
    </div>
  </div>
  <div class="topbar-right">
    <button class="btn btn-ghost btn-sm" onclick="openExportModal()">‚Üó Export</button>
    <button class="btn btn-gold" onclick="openModal()">+ Neuer Deal</button>
  </div>
</div>

<!-- CONTENT -->
<div class="content">

  <!-- DASHBOARD VIEW -->
  <div class="view active" id="view-dashboard">
    <div class="kpi-bar" id="kpi-bar">
      <div class="kpi-card kpi-gold">
        <div class="kpi-icon">üíº</div>
        <div class="kpi-label">Portfolio-Unternehmen</div>
        <div class="kpi-value" id="kpi-total">0</div>
        <div class="kpi-sub" id="kpi-sub-total">Closed Buyouts</div>
      </div>
      <div class="kpi-card kpi-navy">
        <div class="kpi-icon">‚Üó</div>
        <div class="kpi-label">√ò IRR</div>
        <div class="kpi-value" id="kpi-active">‚Äî</div>
        <div class="kpi-sub">√úber alle Deals</div>
      </div>
      <div class="kpi-card kpi-green">
        <div class="kpi-icon">‚óà</div>
        <div class="kpi-label">Invested Equity</div>
        <div class="kpi-value" id="kpi-vol">‚Ç¨0M</div>
        <div class="kpi-sub">Kumuliert</div>
      </div>
      <div class="kpi-card kpi-red">
        <div class="kpi-icon">‚¨°</div>
        <div class="kpi-label">√ò MOIC</div>
        <div class="kpi-value" id="kpi-progress">‚Äî</div>
        <div class="kpi-sub">Multiple on Invested Capital</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 340px;gap:20px;">
      <div>
        <div class="section-head">
          <div><span class="section-title">Portfolio</span><span class="section-count" id="dash-count">0</span></div>
          <button class="btn btn-ghost btn-sm" onclick="switchNav('projects', document.querySelectorAll('.nav-item')[1])">Alle anzeigen</button>
        </div>
        <div class="projects-grid" id="dash-projects-grid" style="grid-template-columns:1fr;"></div>
        <div class="empty-state" id="dash-empty" style="display:none;">
          <div class="empty-icon">üìã</div>
          <div class="empty-title">Noch keine Deals</div>
          <div class="empty-sub">Starte deinen ersten M&A Deal.</div>
        </div>
      </div>
      <div>
        <div class="section-head" style="margin-bottom:14px;">
          <span class="section-title">Aktivit√§ten</span>
        </div>
        <div class="info-card" style="padding:18px;">
          <div id="activity-feed">
            <div class="activity-item">
              <div class="act-avatar avatar-you">YN</div>
              <div class="act-text"><strong>Yannick</strong> hat EterniTrack eingerichtet.</div>
              <div class="act-time">Jetzt</div>
            </div>
          </div>
        </div>
        <div class="section-head" style="margin-top:20px;margin-bottom:14px;">
          <span class="section-title">Team-Notizen</span>
        </div>
        <div class="info-card" style="padding:18px;">
          <div id="notes-list">
            <div class="note-item">
              <div class="note-meta">YN ¬∑ Heute</div>
              <div class="note-text">Workspace bereit. Deals anlegen & gemeinsam mit dem Chef bearbeiten.</div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;">
            <input class="form-input" id="note-input" placeholder="Notiz hinzuf√ºgen‚Ä¶" style="font-size:12.5px;padding:9px 12px;">
            <button class="btn btn-primary btn-sm" onclick="addNote()">+</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROJECTS VIEW -->
  <div class="view" id="view-projects">
    <div class="section-head">
      <div><span class="section-title">Alle Deals</span><span class="section-count" id="all-count">0</span></div>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-ghost btn-sm" onclick="openExportModal()">‚Üó Export</button>
        <button class="btn btn-gold" onclick="openModal()">+ Neuer Deal</button>
      </div>
    </div>
    <div class="projects-grid" id="all-projects-grid"></div>
    <div class="empty-state" id="all-empty" style="display:none;">
      <div class="empty-icon">üíº</div>
      <div class="empty-title">Keine Deals vorhanden</div>
      <div class="empty-sub">F√ºge deinen ersten M&A Deal hinzu.</div>
    </div>
  </div>

  <!-- OVERVIEW GANTT VIEW -->
  <div class="view" id="view-overview">
    <!-- Inline (normal) gantt -->
    <div class="gantt-container" style="height:calc(100vh - 148px);">
      <div class="gantt-canvas" id="gantt-canvas-normal">
        <div class="gantt-topbar">
          <div>
            <div class="gantt-topbar-title">Deal Timeline</div>
            <div class="gantt-topbar-sub">EterniTeam GmbH ¬∑ Portfolio √úbersicht</div>
          </div>
          <div class="gantt-topbar-actions">
            <div class="gantt-legend">
              <div class="gantt-legend-item"><div class="gl-pip gl-dd"></div>DD</div>
              <div class="gantt-legend-item"><div class="gl-pip" style="background:#c084fc;"></div>LOI</div>
              <div class="gantt-legend-item"><div class="gl-pip gl-signing"></div>Signing</div>
              <div class="gantt-legend-item"><div class="gl-pip gl-closing"></div>Closing</div>
              <div class="gantt-legend-item"><div class="gl-today-pip"></div>Heute</div>
            </div>
            <button class="gantt-btn" onclick="openExportModal()">‚Üó Export</button>
            <button class="gantt-btn gantt-btn-primary" onclick="openGanttFullscreen()">‚õ∂ Vollbild</button>
          </div>
        </div>
        <div class="gantt-scroll-area">
          <div id="gantt-content"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN GANTT OVERLAY -->
  <div class="gantt-fullscreen-overlay" id="gantt-fs-overlay">
    <div class="gantt-canvas" style="flex:1;">
      <div class="gantt-topbar">
        <div>
          <div class="gantt-topbar-title">Deal Timeline</div>
          <div class="gantt-topbar-sub">EterniTeam GmbH ¬∑ Portfolio √úbersicht</div>
        </div>
        <div class="gantt-topbar-actions">
          <div class="gantt-legend">
            <div class="gantt-legend-item"><div class="gl-pip gl-dd"></div>DD</div>
            <div class="gantt-legend-item"><div class="gl-pip" style="background:#c084fc;"></div>LOI</div>
            <div class="gantt-legend-item"><div class="gl-pip gl-signing"></div>Signing</div>
            <div class="gantt-legend-item"><div class="gl-pip gl-closing"></div>Closing</div>
            <div class="gantt-legend-item"><div class="gl-today-pip"></div>Heute</div>
          </div>
          <button class="gantt-btn" onclick="openExportModal()">‚Üó Export</button>
          <button class="gantt-close-fs" onclick="closeGanttFullscreen()">‚úï Schlie√üen</button>
        </div>
      </div>
      <div class="gantt-scroll-area">
        <div id="gantt-content-fs"></div>
      </div>
    </div>
  </div>

  <!-- DETAIL VIEW -->
  <div class="view" id="view-detail">
    <div id="detail-content"></div>
  </div>

  <!-- CHECKLIST VIEW -->
  <div class="view" id="view-checklist">
    <div class="section-head">
      <span class="section-title">Deal-Checklisten</span>
    </div>
    <div id="checklist-content"></div>
    <div class="empty-state" id="checklist-empty" style="display:none;">
      <div class="empty-icon">‚ú¶</div>
      <div class="empty-title">Keine Deals vorhanden</div>
      <div class="empty-sub">Erstelle Deals um Checklisten zu sehen.</div>
    </div>
  </div>

</div>
<!-- END CONTENT -->

<!-- FOOTER -->
<footer>
  <div class="footer-brand"><strong>EterniTrack</strong> ‚Äî M&A Deal Intelligence ¬∑ EterniTeam GmbH</div>
  <div class="footer-credit">Entwickelt von <span>Yannick</span></div>
</footer>

</div>
<!-- END MAIN WRAPPER -->

<!-- ADD DEAL MODAL (content injected by openModal / resetAddModal) -->
<div class="overlay" id="add-modal" onclick="closeModalOutside(event,'add-modal')"></div>

<!-- EXPORT MODAL -->
<div class="overlay" id="export-modal" onclick="closeModalOutside(event,'export-modal')">
  <div class="modal-box" style="width:520px;">
    <div class="modal-title">Export</div>
    <div class="modal-sub">W√§hle das Format und den Umfang f√ºr deinen Export.</div>
    <div class="export-options">
      <div class="export-opt sel" id="exp-pdf" onclick="selExport('pdf')">
        <div class="exp-icon">üìÑ</div>
        <div class="exp-name">Deal Report PDF</div>
        <div class="exp-desc">Clean, druckbarer Dealreport</div>
      </div>
      <div class="export-opt" id="exp-csv" onclick="selExport('csv')">
        <div class="exp-icon">üìä</div>
        <div class="exp-name">CSV Export</div>
        <div class="exp-desc">Alle Deals als Tabelle</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Auswahl</label>
      <select class="form-select" id="exp-scope">
        <option value="all">Alle Deals</option>
        <option value="active">Nur aktive Deals</option>
        <option value="single">Einzelner Deal (aktuell gew√§hlt)</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Report-Titel</label>
      <input class="form-input" id="exp-title" value="M&A Deal Report ‚Äî EterniTeam GmbH">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('export-modal')">Abbrechen</button>
      <button class="btn btn-primary" onclick="runExport()">Export starten ‚Üí</button>
    </div>
  </div>
</div>


<!-- PIPEDRIVE SYNC MODAL -->
<div class="overlay" id="pd-modal" onclick="closeModalOutside(event,'pd-modal')">
  <div class="modal-box" style="width:560px;">
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:6px;">
      <div style="width:36px;height:36px;background:#017737;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;">üê≥</div>
      <div>
        <div class="modal-title" style="margin-bottom:0;">Pipedrive Sync</div>
        <div style="font-size:12px;color:var(--muted);">Pipeline: <strong>Targets</strong> ¬∑ Nur ausgew√§hlte Stages</div>
      </div>
    </div>

    <div id="pd-status-bar" class="pd-status-bar pd-disconnected" style="margin-top:20px;">
      <div class="pd-dot pd-dot-grey"></div>
      <span id="pd-status-text">Nicht verbunden ‚Äî API-Key eingeben</span>
    </div>

    <!-- STEP 1: API KEY -->
    <div id="pd-step-apikey">
      <div class="form-group">
        <label class="form-label">Pipedrive API-Key *</label>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="pd-apikey" type="password" placeholder="Dein API-Token aus Pipedrive ‚Üí Einstellungen ‚Üí API">
          <button class="btn btn-primary" onclick="pdConnect()" style="white-space:nowrap;flex-shrink:0;">Verbinden ‚Üí</button>
        </div>
        <div style="margin-top:8px;font-size:11.5px;color:var(--muted);">
          Zu finden in Pipedrive unter <strong>Einstellungen ‚Üí Pers√∂nliche Einstellungen ‚Üí API</strong>. Wird nur lokal gespeichert.
        </div>
      </div>
    </div>

    <!-- STEP 2: STAGE FILTER (shown after connect) -->
    <div id="pd-step-stages" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div style="font-size:13px;font-weight:600;">Stages aus "Targets" Pipeline</div>
        <button class="btn btn-ghost btn-sm" onclick="pdDisconnect()">Trennen</button>
      </div>
      <div class="stage-list" id="pd-stage-list">
        <div style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">Stages werden geladen‚Ä¶</div>
      </div>
      <div id="pd-preview-area" style="display:none;">
        <div class="sync-preview">
          <div class="sync-preview-title">Vorschau ‚Äî <span id="pd-preview-count">0</span> Deals gefunden</div>
          <div id="pd-preview-list"></div>
        </div>
      </div>
      <div id="pd-last-sync-text" class="pd-last-sync" style="margin-top:8px;"></div>
    </div>

    <div class="modal-footer" style="margin-top:20px;">
      <button class="btn btn-ghost" onclick="closeModal('pd-modal')">Schlie√üen</button>
      <button class="btn btn-primary" id="pd-sync-btn" style="display:none;" onclick="pdRunSync()">
        <span id="pd-sync-label">Ausgew√§hlte Deals importieren ‚Üí</span>
      </button>
    </div>
  </div>
</div>

<!-- PRINT / EXPORT AREA (hidden) -->
<div id="print-area" style="display:none;"></div>

<script>
// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
// Passwort hier √§ndern ‚Üì
const ET_PASSWORD = 'EterniTeam2025';
const ET_DOMAIN   = '@eterniteam.de';

function checkAuth() {
  if (sessionStorage.getItem('et_auth') === '1') {
    document.getElementById('login-overlay').style.display = 'none';
    const user = sessionStorage.getItem('et_user') || '';
    const el = document.getElementById('logout-user-display');
    if (el && user) el.textContent = user;
  }
}

function doLogin() {
  const email = (document.getElementById('login-email').value || '').trim().toLowerCase();
  const pwd   = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');

  errEl.style.display = 'none';

  if (!email.endsWith(ET_DOMAIN)) {
    errEl.textContent = 'Nur @eterniteam.de E-Mail-Adressen sind erlaubt.';
    errEl.style.display = 'block';
    return;
  }
  if (pwd !== ET_PASSWORD) {
    errEl.textContent = 'Falsches Passwort. Bitte versuche es erneut.';
    errEl.style.display = 'block';
    return;
  }

  sessionStorage.setItem('et_auth', '1');
  sessionStorage.setItem('et_user', email);
  document.getElementById('login-overlay').style.display = 'none';
  const el = document.getElementById('logout-user-display');
  if (el) el.textContent = email;
}

function doLogout() {
  sessionStorage.removeItem('et_auth');
  sessionStorage.removeItem('et_user');
  location.reload();
}

// Enter-Taste im Login-Formular
document.addEventListener('keydown', function(e) {
  const overlay = document.getElementById('login-overlay');
  if (overlay && overlay.style.display !== 'none' && e.key === 'Enter') {
    doLogin();
  }
});

checkAuth();

// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ
const PHASES = [
  { name:'Vorbereitung & NDA', icon:'üìã', desc:'Initialkontakt, NDAs, Projektstruktur, Teambriefing und erste Bewertungsmodelle erstellen.', tasks:['Projektteam aufstellen','NDA unterzeichnet','Management Presentation erhalten','Bewertungsmodell Entwurf','Kick-off Meeting'] },
  { name:'Due Diligence', icon:'üîç', desc:'Umfassende rechtliche, finanzielle, steuerliche und operative Pr√ºfung des Zielunternehmens.', tasks:['Financial DD','Legal DD','Tax DD','Commercial DD','IT & Cyber DD','ESG-Pr√ºfung'] },
  { name:'Verhandlung & LOI', icon:'ü§ù', desc:'Verhandlung der wesentlichen Deal-Parameter und Unterzeichnung des Letter of Intent.', tasks:['Key Terms festgelegt','Bewertungsanpassungen','LOI unterzeichnet','Exklusivit√§t','Finanzierungsstruktur'] },
  { name:'Signing', icon:'‚úçÔ∏è', desc:'Finale SPA-Verhandlung, Vertragsunterzeichnung und Vorbereitung des Vollzugs.', tasks:['SPA finalisiert','W&I Versicherung','Garantienkatalog','Signing-Termin','Escrow-Konto'] },
  { name:'Regulatory Approval', icon:'üèõÔ∏è', desc:'Einholung beh√∂rdlicher Genehmigungen, Kartellrecht und sektorale Aufsicht.', tasks:['BKartA Anmeldung','EU-Kommission ggf.','Sektorale Beh√∂rden','Freigabebescheid','Auflagen pr√ºfen'] },
  { name:'Closing', icon:'üéØ', desc:'Vollzug, Kaufpreiszahlung, Eigentums√ºbertragung und Post-Merger-Integration.', tasks:['Closing-Conditions','Kaufpreis transferiert','Eigentums√ºbertragung','PMI-Kick-off','Closing-Statement'] },
];

let projects = [
  // ‚îÄ‚îÄ CLOSED DEALS ‚îÄ‚îÄ
  {
    id: 1, name: 'VEGANOVA', buyer: 'EterniTeam GmbH', target: 'Veganova GmbH',
    sector: 'Fruit & vegetable wholeseller', region: 'Bavaria',
    revenues: 4451, ebitda: 745, ebit: 727, ebitMargin: 16.33,
    ev: 2000, earnOutPct: null, fixedPrice: null, equityCash: null,
    ebitdaMultiple: 2.68, ebitMultiple: 2.75, irr: 56.94,
    dealStatus: 'Deal closed', status: 'closed', phase: 5, risk: 'low',
    start: '2025-01-15', end: '2025-08-12',
    loiDate: '2025-03-20', ddStart: '2025-04-01', ddEnd: '2025-06-15',
    signingDate: '2025-07-10', closingDate: '2025-08-12',
    desc: 'Fruit & vegetable wholeseller in Bavaria. Stable B2B business model with long-standing customer relationships. IRR 56.94% ‚Äî first EterniTeam portfolio company.',
  },
  {
    id: 2, name: 'AQUA', buyer: 'EterniTeam GmbH', target: 'Aqua Sanit√§r GmbH',
    sector: 'Craft Business ‚Äì Sanitary Installation', region: 'North-Rhine Westfalia',
    revenues: 3306, ebitda: 714, ebit: 650, ebitMargin: 19.66,
    ev: 2197, earnOutPct: null, fixedPrice: null, equityCash: null,
    ebitdaMultiple: 3.08, ebitMultiple: 3.38, irr: 51.21,
    dealStatus: 'Deal closed', status: 'closed', phase: 5, risk: 'low',
    start: '2025-02-01', end: '2025-08-28',
    loiDate: '2025-04-15', ddStart: '2025-05-01', ddEnd: '2025-07-01',
    signingDate: '2025-08-01', closingDate: '2025-08-28',
    desc: 'Sanitary installation company in NRW with strong regional market position. High EBITDA margin of 19.66%. Second buyout ‚Äî IRR 51.21%.',
  },
  {
    id: 3, name: 'HODOR', buyer: 'EterniTeam GmbH', target: 'Hodor Fenster & T√ºren GmbH',
    sector: 'Window and Door Installer', region: 'Berlin',
    revenues: 4195, ebitda: 768, ebit: 696, ebitMargin: 16.59,
    ev: 2855, earnOutPct: null, fixedPrice: null, equityCash: null,
    ebitdaMultiple: 3.72, ebitMultiple: 4.10, irr: 35.77,
    dealStatus: 'Deal closed', status: 'closed', phase: 5, risk: 'low',
    start: '2025-01-20', end: '2025-07-15',
    loiDate: '2025-03-10', ddStart: '2025-03-25', ddEnd: '2025-05-30',
    signingDate: '2025-06-20', closingDate: '2025-07-15',
    desc: 'Window and door installer in Berlin. Largest of the three Q3 deals with EV ‚Ç¨2.855M. Third buyout ‚Äî IRR 35.77%.',
  },
  // ‚îÄ‚îÄ LOI SENT ‚îÄ‚îÄ
  {
    id: 4, name: 'TO GO', buyer: 'EterniTeam GmbH', target: 'To Go Packaging GmbH',
    sector: 'Integrated packaging solutions provider', region: 'Hesse',
    revenues: 7200, ebitda: 979, ebit: 966, ebitMargin: 13.42,
    ev: 3005, earnOutPct: 33.33, fixedPrice: 2003, equityCash: 751,
    ebitdaMultiple: 3.07, ebitMultiple: 3.11, irr: 48.63,
    dealStatus: 'LOI sent', status: 'active', phase: 2, risk: 'medium',
    start: '2025-06-01', end: '2026-03-01',
    loiDate: '2025-11-15', ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Integrated packaging solutions provider in Hesse. Strong revenue base of ‚Ç¨7.2M with 33.33% earn-out structure.',
  },
  {
    id: 5, name: 'METRO', buyer: 'EterniTeam GmbH', target: 'Metro Metallbau GmbH',
    sector: 'Specialized metal construction', region: 'Berlin',
    revenues: 2854, ebitda: 709, ebit: 653, ebitMargin: 22.89,
    ev: 2415, earnOutPct: 35.00, fixedPrice: 1570, equityCash: 589,
    ebitdaMultiple: 3.41, ebitMultiple: 3.70, irr: 45.35,
    dealStatus: 'LOI sent', status: 'active', phase: 2, risk: 'medium',
    start: '2025-07-01', end: '2026-04-01',
    loiDate: '2025-12-01', ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Specialized metal construction company in Berlin. High EBIT margin of 22.89%. 35% earn-out component.',
  },
  {
    id: 6, name: 'FLOOR', buyer: 'EterniTeam GmbH', target: 'Floor Coating GmbH',
    sector: 'Floor coating service provider', region: 'Rhineland-Palatinate',
    revenues: 12458, ebitda: 1433, ebit: 1311, ebitMargin: 10.52,
    ev: 3918, earnOutPct: 35.00, fixedPrice: 2546, equityCash: 955,
    ebitdaMultiple: 2.73, ebitMultiple: 2.99, irr: 60.60,
    dealStatus: 'LOI sent', status: 'active', phase: 2, risk: 'medium',
    start: '2025-05-01', end: '2026-02-01',
    loiDate: '2025-10-15', ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Floor coating service provider in Rhineland-Palatinate. Largest revenue of active deals at ‚Ç¨12.5M. Projected IRR 60.6%.',
  },
  // ‚îÄ‚îÄ LOI PREPARATION ‚îÄ‚îÄ
  {
    id: 7, name: 'MOTION', buyer: 'EterniTeam GmbH', target: 'Motion Vehicle Support GmbH',
    sector: 'Technical Vehicle Support', region: 'Bavaria',
    revenues: 3573, ebitda: 678, ebit: 717, ebitMargin: 20.08,
    ev: 2046, earnOutPct: 30.00, fixedPrice: 1432, equityCash: 537,
    ebitdaMultiple: 3.02, ebitMultiple: 2.85, irr: 58.06,
    dealStatus: 'LOI preparation', status: 'active', phase: 2, risk: 'medium',
    start: '2025-08-01', end: '2026-05-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Technical vehicle support company in Bavaria. 30% earn-out structure. Projected IRR 58.06%.',
  },
  {
    id: 8, name: 'TIMES SQUARE', buyer: 'EterniTeam GmbH', target: 'Times Square Elektro GmbH',
    sector: 'Electrical installation services', region: 'Baden-W√ºrttemberg',
    revenues: 2518, ebitda: 673, ebit: 594, ebitMargin: 23.61,
    ev: 2151, earnOutPct: 35.00, fixedPrice: 1398, equityCash: 524,
    ebitdaMultiple: 3.20, ebitMultiple: 3.62, irr: 46.62,
    dealStatus: 'LOI preparation', status: 'active', phase: 2, risk: 'medium',
    start: '2025-09-01', end: '2026-06-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Electrical installation services in Baden-W√ºrttemberg. High EBIT margin of 23.61%. 35% earn-out component.',
  },
  // ‚îÄ‚îÄ IO NEGOTIATION ‚îÄ‚îÄ
  {
    id: 9, name: 'GUMMI', buyer: 'EterniTeam GmbH', target: 'Gummi Beschichtung GmbH',
    sector: 'Floor coating service provider', region: 'Rhineland-Palatinate',
    revenues: 6073, ebitda: 1043, ebit: 922, ebitMargin: 15.18,
    ev: 3467, earnOutPct: 40.00, fixedPrice: 2080, equityCash: 780,
    ebitdaMultiple: 3.33, ebitMultiple: 3.76, irr: 43.86,
    dealStatus: 'IO negotiation', status: 'active', phase: 1, risk: 'medium',
    start: '2025-09-01', end: '2026-08-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Floor coating service provider in Rhineland-Palatinate. 40% earn-out structure. Projected IRR 43.86%.',
  },
  {
    id: 10, name: 'ROSIN', buyer: 'EterniTeam GmbH', target: 'Rosin K√ºchentechnik GmbH',
    sector: 'Commercial kitchen installer', region: 'North-Rhine Westfalia',
    revenues: 4125, ebitda: 640, ebit: 619, ebitMargin: 15.00,
    ev: 1838, earnOutPct: 39.00, fixedPrice: 1121, equityCash: 421,
    ebitdaMultiple: 2.87, ebitMultiple: 2.97, irr: 50.12,
    dealStatus: 'IO negotiation', status: 'active', phase: 1, risk: 'medium',
    start: '2025-10-01', end: '2026-09-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Commercial kitchen installer in NRW. 39% earn-out structure. Projected IRR 50.12%.',
  },
  {
    id: 11, name: 'PRINTER', buyer: 'EterniTeam GmbH', target: 'Printer Print Services GmbH',
    sector: 'Commercial print services', region: 'Hesse',
    revenues: 2931, ebitda: 1227, ebit: 1151, ebitMargin: 39.26,
    ev: 3009, earnOutPct: 99.00, fixedPrice: 30, equityCash: 11,
    ebitdaMultiple: 2.45, ebitMultiple: 2.61, irr: null,
    dealStatus: 'IO negotiation', status: 'active', phase: 1, risk: 'high',
    start: '2025-10-01', end: '2026-09-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Commercial print services in Hesse. Exceptional EBITDA margin of 39.26%. High earn-out component (99%) ‚Äî IRR calculation pending.',
  },
  // ‚îÄ‚îÄ IO SENT ‚îÄ‚îÄ
  {
    id: 12, name: 'CANVAS', buyer: 'EterniTeam GmbH', target: 'Canvas Malerbetrieb GmbH',
    sector: 'Painting services', region: '',
    revenues: 3292, ebitda: 639, ebit: 588, ebitMargin: 16.73,
    ev: 1980, earnOutPct: 35.00, fixedPrice: 1287, equityCash: 483,
    ebitdaMultiple: 3.10, ebitMultiple: 3.37, irr: 46.37,
    dealStatus: 'IO sent', status: 'active', phase: 1, risk: 'medium',
    start: '2025-10-01', end: '2026-08-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Painting services company. 35% earn-out structure. Projected IRR 46.37%.',
  },
  // ‚îÄ‚îÄ IO IN PREPARATION ‚îÄ‚îÄ
  {
    id: 13, name: 'FLOW', buyer: 'EterniTeam GmbH', target: 'Flow Absaugtechnik GmbH',
    sector: 'Suction technology manufacturer', region: 'North-Rhine Westfalia',
    revenues: 2248, ebitda: 527, ebit: 462, ebitMargin: 20.56,
    ev: 1803, earnOutPct: 40.00, fixedPrice: 1082, equityCash: 406,
    ebitdaMultiple: 3.42, ebitMultiple: 3.90, irr: 45.45,
    dealStatus: 'IO in preparation', status: 'active', phase: 0, risk: 'medium',
    start: '2025-11-01', end: '2026-09-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Suction technology manufacturer in NRW. High EBIT margin of 20.56%. 40% earn-out component.',
  },
  {
    id: 14, name: 'LISSABON', buyer: 'EterniTeam GmbH', target: 'Lissabon Wohnbau GmbH',
    sector: 'Residential homebuilding services', region: 'Hesse',
    revenues: 6963, ebitda: 1564, ebit: 1540, ebitMargin: 16.73,
    ev: 4496, earnOutPct: 40.00, fixedPrice: 2698, equityCash: 1012,
    ebitdaMultiple: 2.88, ebitMultiple: 2.92, irr: 65.29,
    dealStatus: 'IO in preparation', status: 'active', phase: 0, risk: 'medium',
    start: '2025-11-01', end: '2026-10-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Residential homebuilding services in Hesse. Highest projected IRR in active pipeline at 65.29%. Largest EV of active deals at ‚Ç¨4.496M.',
  },
  {
    id: 15, name: 'SEGOVIA', buyer: 'EterniTeam GmbH', target: 'Segovia Metallbau GmbH',
    sector: 'Hospitality metal fabrication', region: '',
    revenues: 6133, ebitda: 1027, ebit: 948, ebitMargin: 15.46,
    ev: 3148, earnOutPct: 40.00, fixedPrice: 966, equityCash: 362,
    ebitdaMultiple: 3.07, ebitMultiple: 3.32, irr: 49.74,
    dealStatus: 'IO in preparation', status: 'active', phase: 0, risk: 'medium',
    start: '2025-12-01', end: '2026-11-01',
    loiDate: null, ddStart: null, ddEnd: null,
    signingDate: null, closingDate: null,
    desc: 'Hospitality metal fabrication company. 40% earn-out structure. Projected IRR 49.74%.',
  },
];
let nextId = 16;
let selectedExport = 'pdf';
let currentDetailId = null;

const activities = [
  { user:'YN', text:'hat <strong>HODOR</strong> als Closed markiert ‚Äî IRR 35,77%', time:'15. Jul 2025' },
  { user:'CH', text:'hat <strong>VEGANOVA</strong> als Closed markiert ‚Äî IRR 56,94%', time:'12. Aug 2025' },
  { user:'YN', text:'hat <strong>AQUA</strong> als Closed markiert ‚Äî IRR 51,21%', time:'28. Aug 2025' },
  { user:'CH', text:'Q3 2025 abgeschlossen ‚Äî 3 Buyouts, √ò IRR 48,0%', time:'Sep 2025' },
];

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function renderAll() {
  renderKPI();
  renderDashProjects();
  renderAllProjects();
  renderGantt();
  renderChecklist();
  updateBadge();
  renderActivities();
}

function updateBadge() {
  document.getElementById('nav-badge').textContent = projects.length;
  document.getElementById('all-count').textContent = projects.length;
  document.getElementById('dash-count').textContent = projects.length;
}

function renderKPI() {
  const closed = projects.filter(p => p.status === 'closed');
  document.getElementById('kpi-total').textContent = closed.length;
  document.getElementById('kpi-sub-total').textContent = closed.length === 1 ? 'Closed Buyout' : 'Closed Buyouts';
  // √ò IRR
  const avgIRR = closed.length ? (closed.reduce((s,p) => s + (p.irr||0), 0) / closed.length) : 0;
  document.getElementById('kpi-active').textContent = avgIRR ? avgIRR.toFixed(1) + '%' : '‚Äî';
  // Invested Equity (sum of equity in Tsd ‚Üí to Mio)
  const totalEq = closed.reduce((s,p) => s + (p.equity||0), 0);
  document.getElementById('kpi-vol').textContent = totalEq >= 1000 ? `‚Ç¨${(totalEq/1000).toFixed(2)}M` : `‚Ç¨${totalEq}k`;
  // √ò MOIC
  const avgMOIC = closed.length ? (closed.reduce((s,p) => s + (p.moicFull||0), 0) / closed.length) : 0;
  document.getElementById('kpi-progress').textContent = avgMOIC ? avgMOIC.toFixed(2) + 'x' : '‚Äî';
}

function renderActivities() {
  const feed = document.getElementById('activity-feed');
  const all = [...activities];
  feed.innerHTML = all.map(a => `
    <div class="activity-item">
      <div class="act-avatar ${a.user === 'YN' ? 'avatar-you' : 'avatar-boss'}">${a.user}</div>
      <div class="act-text">${a.user === 'YN' ? '<strong>Yannick</strong>' : '<strong>Chef</strong>'} ${a.text}</div>
      <div class="act-time">${a.time}</div>
    </div>`).join('') + `
    <div class="activity-item">
      <div class="act-avatar avatar-you">YN</div>
      <div class="act-text"><strong>Yannick</strong> hat EterniTrack eingerichtet.</div>
      <div class="act-time">Heute</div>
    </div>`;
}

function makeCard(p, compact = false) {
  const prog = Math.round(p.phase / 5 * 100);
  const dots = PHASES.map((_,i) => `<div class="pdot ${i < p.phase ? 'done' : i === p.phase ? 'current' : ''}"></div>`).join('');
  const statusLabel = { active:'Aktiv', closed:'Abgeschlossen', pending:'Ausstehend' }[p.status];
  const isClosed = p.status === 'closed';
  const closedDate = p.closedDate ? fmtDate(p.closedDate) : fmtDate(p.end);

  // Financial metrics block
  const financialsHtml = `
    <div class="card-metrics" style="grid-template-columns:repeat(3,1fr);">
      <div class="metric"><div class="metric-label">EV</div><div class="metric-val gold">‚Ç¨${p.ev ? (p.ev/1000).toFixed(2)+'M' : '‚Äî'}</div></div>
      <div class="metric"><div class="metric-label">EBITDA</div><div class="metric-val">‚Ç¨${p.ebitda ? (p.ebitda/1000).toFixed(2)+'M' : '‚Äî'}</div></div>
      <div class="metric"><div class="metric-label">IRR</div><div class="metric-val gold">${p.irr != null ? p.irr.toFixed(2)+'%' : '#NUM!'}</div></div>
    </div>
    <div class="card-metrics" style="grid-template-columns:repeat(3,1fr);margin-top:8px;">
      <div class="metric"><div class="metric-label">EBITDA Multiple</div><div class="metric-val">${p.ebitdaMultiple ? p.ebitdaMultiple.toFixed(2)+'x' : '‚Äî'}</div></div>
      <div class="metric"><div class="metric-label">EBIT Multiple</div><div class="metric-val">${p.ebitMultiple ? p.ebitMultiple.toFixed(2)+'x' : '‚Äî'}</div></div>
      <div class="metric"><div class="metric-label">EBIT Margin</div><div class="metric-val">${p.ebitMargin ? p.ebitMargin.toFixed(2)+'%' : '‚Äî'}</div></div>
    </div>`;

  return `
  <div class="project-card" onclick="openDetail(${p.id})">
    <div class="card-header">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="deal-badge badge-buyout">BUYOUT</div>
        <span style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;">${p.region || ''}</span>
      </div>
      <div class="status-pill s-${p.status}">
        <div class="status-dot"></div>
        <span>${p.dealStatus || statusLabel}</span>
      </div>
    </div>
    <div class="card-name">${p.name}</div>
    <div class="card-parties"><strong>EterniTeam GmbH</strong> <span style="color:var(--muted2)">‚Üí</span> <strong>${p.target}</strong></div>
    <div style="font-size:11px;color:var(--muted);margin-top:-10px;margin-bottom:16px;font-family:'DM Mono',monospace;">${p.sector || ''}</div>
    ${financialsHtml}
    <div style="margin-top:14px;display:flex;gap:6px;">
      <div style="flex:1;background:var(--gold-bg);border-radius:8px;padding:8px 10px;text-align:center;">
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--green);font-family:'DM Mono',monospace;margin-bottom:2px;">IRR</div>
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:700;color:var(--navy);">${p.irr != null ? p.irr.toFixed(2)+'%' : '#NUM!'}</div>
      </div>
      <div style="flex:1;background:var(--navy-light);border-radius:8px;padding:8px 10px;text-align:center;">
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--navy);font-family:'DM Mono',monospace;opacity:0.6;margin-bottom:2px;">EBITDA</div>
        <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--navy);">${p.ebitdaMultiple?.toFixed(2) || '‚Äî'}x</div>
      </div>
      <div style="flex:1;background:var(--bg2);border-radius:8px;padding:8px 10px;text-align:center;">
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:2px;">EBIT</div>
        <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--ink);">${p.ebitMultiple?.toFixed(2) || '‚Äî'}x</div>
      </div>
    </div>
    ${!isClosed ? `
    <div class="card-progress-label" style="margin-top:12px;">
      <span><strong>${PHASES[p.phase].name}</strong></span>
      <span>${prog}%</span>
    </div>
    <div class="progress-track"><div class="progress-fill" style="width:${prog}%"></div></div>
    <div class="phase-dots">${dots}</div>` : `
    <div style="margin-top:8px;font-size:11px;font-family:'DM Mono',monospace;color:var(--muted);text-align:right;">Closed ${p.closingDate ? fmtDate(p.closingDate) : ''}</div>`}
  </div>`;
}

function renderDashProjects() {
  const active = projects.slice(0, 3);
  const grid = document.getElementById('dash-projects-grid');
  const empty = document.getElementById('dash-empty');
  if (active.length === 0) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = active.map(p => makeCard(p, true)).join('');
}

function renderAllProjects() {
  const grid = document.getElementById('all-projects-grid');
  const empty = document.getElementById('all-empty');
  if (projects.length === 0) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = projects.map(p => makeCard(p)).join('');
}

function buildGanttHTML() {
  return ''; // replaced by renderGanttCanvas()
}

function renderGanttCanvas() {
  const containers = ['gantt-content', 'gantt-content-fs'];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;

    if (projects.length === 0) {
      el.innerHTML = '<div style="color:#a0b4c8;text-align:center;padding:60px;font-size:13px;">Keine Deals vorhanden</div>';
      return;
    }

    const mNames = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
    const today = new Date();

    // Range: earliest start to 18 months from latest end (future scrollable)
    const allStarts = projects.map(p => new Date(p.start));
    const allEnds   = projects.map(p => new Date(p.end));
    const minD = new Date(Math.min(...allStarts)); minD.setDate(1);
    const maxD = new Date(Math.max(...allEnds));
    maxD.setMonth(maxD.getMonth() + 12); maxD.setDate(1); // 12 months into future

    const months = [];
    let c = new Date(minD);
    while (c <= maxD) { months.push(new Date(c)); c.setMonth(c.getMonth()+1); }

    // px per month ‚Äî each month is 80px wide, giving horizontal scroll
    const PX_MONTH = 80;
    const totalPx  = months.length * PX_MONTH;
    const totalMs  = maxD - minD;

    const px = d => Math.max(0, (new Date(d) - minD) / totalMs * totalPx);
    const todayPx = px(today);

    // ‚îÄ‚îÄ Build label pane ‚îÄ‚îÄ
    const labelRows = projects.map(p => `
      <div class="gantt-label-row" onclick="openDetail(${p.id})">
        <div class="gl-row-name">${p.name}</div>
        <div class="gl-row-sub">${p.target}</div>
        ${p.irr ? `<div class="gl-row-irr">IRR ${p.irr.toFixed(1)}%</div>` : ''}
      </div>`).join('');

    // ‚îÄ‚îÄ Build track pane ‚îÄ‚îÄ
    // Month header cells
    const monthCells = months.map((m, i) => {
      const xPx = i * PX_MONTH + PX_MONTH/2;
      const isCur = m.getMonth() === today.getMonth() && m.getFullYear() === today.getFullYear();
      const label = mNames[m.getMonth()] + (m.getMonth() === 0 || i === 0 ? ' ' + m.getFullYear() : '');
      return `<div class="gantt-month-cell${isCur?' gmc-cur':''}" style="left:${xPx}px">${label}</div>`;
    }).join('');

    // Grid lines
    const gridLines = months.map((m, i) => {
      const xPx = i * PX_MONTH;
      const isCur = m.getMonth() === today.getMonth() && m.getFullYear() === today.getFullYear();
      return `<div class="gantt-vgrid-line${isCur?' gvg-cur':''}" style="left:${xPx}px; top:0; bottom:0; position:absolute;"></div>`;
    }).join('');

    // Today line
    const todayLine = `
      <div class="gantt-today-line" style="left:${todayPx}px; position:absolute; top:0; bottom:0;">
        <div class="gantt-today-pip">HEUTE</div>
      </div>`;

    const dealColors = ['gdc-1','gdc-2','gdc-3','gdc-4','gdc-5'];

    const trackRows = projects.map((p, idx) => {
      const pStart = new Date(p.start), pEnd = new Date(p.end);
      const totalMs_deal = pEnd - pStart;
      const barX = px(p.start);
      const barW = Math.max(4, px(p.end) - barX);
      const colorCls = dealColors[idx % dealColors.length];

      // Use actual dates if set, otherwise estimate from phase proportions
      const phasePcts = [0, 0.15, 0.40, 0.60, 0.75, 0.90, 1.0];
      const ddStartD = p.ddStart ? new Date(p.ddStart) : new Date(pStart.getTime() + phasePcts[1] * totalMs_deal);
      const ddEndD   = p.ddEnd   ? new Date(p.ddEnd)   : new Date(pStart.getTime() + phasePcts[2] * totalMs_deal);
      const loiD     = p.loiDate     ? new Date(p.loiDate)     : null;
      const signingD = p.signingDate ? new Date(p.signingDate) : null;
      const closingD = p.closingDate ? new Date(p.closingDate) : (p.status === 'closed' ? pEnd : null);

      // DD stripe relative to bar (only show if DD dates known or phase > 0)
      const ddRelLeft  = (ddStartD - pStart) / totalMs_deal * 100;
      const ddRelWidth = (ddEndD - ddStartD) / totalMs_deal * 100;
      const ddMidPx    = px(new Date((ddStartD.getTime() + ddEndD.getTime()) / 2));

      const diffM = (pEnd.getFullYear()-pStart.getFullYear())*12 + pEnd.getMonth()-pStart.getMonth();

      const fmtOpt = d => d ? fmtDate(d) : '‚Äî';
      const tooltip = `
        <div class="gd-tooltip">
          <div class="gd-tt-name">${p.name}</div>
          <div class="gd-tt-co">${p.target}${p.region ? ' ¬∑ ' + p.region : ''}</div>
          <div class="gd-tt-row"><span class="gd-tt-k">IRR</span><span class="gd-tt-v g">${p.irr ? p.irr.toFixed(2)+'%' : '‚Äî'}</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">EV</span><span class="gd-tt-v">‚Ç¨${p.ev?(p.ev/1000).toFixed(3):'-'}M</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">EBITDA Multiple</span><span class="gd-tt-v">${p.ebitdaMultiple?.toFixed(2) || '‚Äî'}x</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">Status</span><span class="gd-tt-v">${p.dealStatus || '‚Äî'}</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">DD</span><span class="gd-tt-v">${p.ddStart ? fmtDateShort(ddStartD)+' ‚Äì '+fmtDateShort(ddEndD) : 'noch offen'}</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">LOI</span><span class="gd-tt-v">${fmtOpt(loiD)}</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">Signing</span><span class="gd-tt-v">${fmtOpt(signingD)}</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">Closing</span><span class="gd-tt-v">${fmtOpt(closingD)}</span></div>
          <div class="gd-tt-row"><span class="gd-tt-k">Laufzeit</span><span class="gd-tt-v">${diffM} Mo.</span></div>
        </div>`;

      const loiPin    = loiD    ? `<div class="gd-pin gd-pin-loi" style="left:${px(loiD)}px;top:8px;"><div class="gd-pin-dot"></div><div class="gd-pin-line"></div><div class="gd-pin-label">LOI ${fmtDateShort(loiD)}</div></div>` : '';
      const sigPin    = signingD ? `<div class="gd-pin gd-pin-sign" style="left:${px(signingD)}px;top:8px;"><div class="gd-pin-dot"></div><div class="gd-pin-line"></div><div class="gd-pin-label">${fmtDateShort(signingD)}</div></div>` : '';
      const closePin  = closingD ? `<div class="gd-pin gd-pin-close" style="left:${px(closingD)}px;top:8px;"><div class="gd-pin-dot"></div><div class="gd-pin-line"></div><div class="gd-pin-label">${fmtDateShort(closingD)}</div></div>` : '';
      const ddPin     = (p.ddStart || p.phase >= 1) ? `<div class="gd-pin gd-pin-dd" style="left:${ddMidPx}px;top:8px;"><div class="gd-pin-dot"></div><div class="gd-pin-line"></div><div class="gd-pin-label">DD</div></div>` : '';

      return `
      <div class="gantt-track-row">
        <div class="gd-bar ${colorCls}" style="left:${barX}px;width:${barW}px;" onclick="openDetail(${p.id})">
          <div class="gd-dd-stripe" style="left:${ddRelLeft}%;width:${ddRelWidth}%;"></div>
          <div class="gd-bar-body"><span class="gd-bar-label">${p.name}</span></div>
          ${tooltip}
        </div>
        ${ddPin}${loiPin}${sigPin}${closePin}
      </div>`;
    }).join('');

    // ‚îÄ‚îÄ Compose HTML ‚îÄ‚îÄ
    el.innerHTML = `
      <div class="gantt-chart-wrap">
        <!-- Fixed label column -->
        <div class="gantt-label-pane">
          <div class="gantt-label-header">Deal</div>
          <div class="gantt-label-rows">${labelRows}</div>
        </div>
        <!-- Scrollable track -->
        <div class="gantt-track-pane">
          <div class="gantt-track-inner" style="width:${totalPx}px;min-width:100%;">
            <div class="gantt-month-header" style="position:relative;width:${totalPx}px;">
              ${gridLines}
              ${monthCells}
            </div>
            <div class="gantt-track-rows" style="position:relative;width:${totalPx}px;">
              ${gridLines}
              ${todayLine}
              ${trackRows}
            </div>
          </div>
        </div>
      </div>`;

    // Scroll to show earliest deal (a little before it)
    const trackPane = el.querySelector('.gantt-track-pane');
    if (trackPane) {
      const scrollTo = Math.max(0, px(new Date(Math.min(...projects.map(p => new Date(p.start))))) - 40);
      trackPane.scrollLeft = scrollTo;
    }
  });
}

function fmtDateShort(d) {
  return new Date(d).toLocaleDateString('de-DE', { day:'2-digit', month:'short' });
}

function renderGantt() {
  renderGanttCanvas();
}

function openGanttFullscreen() {
  renderGantt();
  document.getElementById('gantt-fs-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeGanttFullscreen() {
  document.getElementById('gantt-fs-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

function renderChecklist() {
  const el = document.getElementById('checklist-content');
  const empty = document.getElementById('checklist-empty');
  if (projects.length === 0) { el.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  el.innerHTML = projects.map(p => {
    const allTasks = PHASES.flatMap((ph, pi) => ph.tasks.map((t, ti) => ({ ph: pi, ti, text: t, done: pi < p.phase || (pi === p.phase && ti < Math.ceil(ph.tasks.length * 0.5)) })));
    const done = allTasks.filter(t => t.done).length;
    const total = allTasks.length;
    const sections = PHASES.map((ph, pi) => {
      const items = ph.tasks.map((t, ti) => {
        const isDone = pi < p.phase || (pi === p.phase && ti < Math.ceil(ph.tasks.length * 0.5));
        return `<div class="task-item t-${isDone?'done':'pending'}">
          <div class="task-box">${isDone ? '‚úì' : ''}</div>
          <span class="task-lbl">${t}</span>
        </div>`;
      }).join('');
      const phDone = pi < p.phase ? ph.tasks.length : pi === p.phase ? Math.ceil(ph.tasks.length*0.5) : 0;
      return `<div style="margin-bottom:14px;">
        <div style="font-size:12px;font-weight:600;color:${pi < p.phase ? 'var(--gold)' : pi === p.phase ? 'var(--navy)' : 'var(--muted)'};margin-bottom:8px;">${ph.icon} Phase ${pi+1} ‚Äî ${ph.name} &nbsp;<span style="font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:400;">(${phDone}/${ph.tasks.length})</span></div>
        ${items}
      </div>`;
    }).join('');
    return `<div class="info-card" style="margin-bottom:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div>
          <div style="font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;">${p.name}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:3px;">EterniTeam GmbH ‚Üí ${p.target} ¬∑ ‚Ç¨${p.volume}M ¬∑ ${p.sector || ''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:500;color:var(--gold);">${done}/${total}</div>
          <div style="font-size:11px;color:var(--muted);">Tasks erledigt</div>
        </div>
      </div>
      <div class="progress-track" style="margin-bottom:20px;"><div class="progress-fill" style="width:${Math.round(done/total*100)}%"></div></div>
      ${sections}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ‚îÄ
function openDetail(id) {
  currentDetailId = id;
  const p = projects.find(x => x.id === id);
  const prog = Math.round(p.phase / 5 * 100);
  const circ = 2 * Math.PI * 26;
  const dash = circ - (prog/100) * circ;

  const phasesHtml = PHASES.map((ph, i) => {
    let state = i < p.phase ? 'ph-done' : i === p.phase ? 'ph-current' : 'ph-future';
    const isLast = i === PHASES.length - 1;
    const tasksDone = i < p.phase ? ph.tasks.length : i === p.phase ? Math.ceil(ph.tasks.length*0.5) : 0;
    const tasksHtml = ph.tasks.map((t,ti) => {
      const d = ti < tasksDone;
      return `<div class="task-item t-${d?'done':'pending'}"><div class="task-box">${d?'‚úì':''}</div><span class="task-lbl">${t}</span></div>`;
    }).join('');
    const phDate = interpDate(p.start, p.end, i/5);
    return `<div class="vt-phase ${state}">
      <div class="vt-col">
        <div class="vt-node">${state === 'ph-done' ? '‚úì' : ph.icon}</div>
        ${!isLast ? '<div class="vt-line" style="flex:1;min-height:60px;"></div>' : ''}
      </div>
      <div class="vt-content">
        <div class="vt-header">
          <div class="vt-title">Phase ${i+1} ‚Äî ${ph.name}</div>
          <div class="vt-date">${i <= p.phase ? fmtDate(phDate) : '‚Äî'}</div>
        </div>
        <div class="vt-card">
          <div class="vt-desc">${ph.desc}</div>
          <div>${tasksHtml}</div>
        </div>
      </div>
    </div>`;
  }).join('');

  const risks = [
    { level: p.risk, label: 'Gesamtrisiko', desc: p.risk === 'low' ? 'Gut strukturiert, geringe Komplexit√§t.' : p.risk === 'medium' ? 'Moderate Komplexit√§t, Monitoring erforderlich.' : 'Hohe Komplexit√§t, enge Steuerung n√∂tig.' },
    { level: 'low', label: 'Regulatory', desc: 'Kartellrechtliche Risiken eingesch√§tzt.' },
    { level: 'medium', label: 'Finanzierung', desc: 'Finanzierungsstruktur in Abstimmung.' },
    { level: 'low', label: 'Integration', desc: 'PMI-Planung l√§uft.' },
  ];
  const riskHtml = risks.map(r => `<div class="risk-item ri-${r.level}"><div class="ri-label">${r.label}</div><div class="ri-desc">${r.desc}</div></div>`).join('');

  document.getElementById('detail-content').innerHTML = `
    <div class="detail-page">
      <div class="detail-top">
        <button class="btn btn-ghost btn-sm" onclick="goBack()">‚Üê Zur√ºck</button>
        <div class="detail-title-block">
          <div class="detail-big-title">${p.name}</div>
          <div class="detail-subtitle">
            <span class="deal-badge badge-buyout" style="display:inline;">BUYOUT</span>
            &nbsp;EterniTeam GmbH ‚Üí ${p.target} &nbsp;¬∑&nbsp; ‚Ç¨${p.volume}M &nbsp;¬∑&nbsp; ${p.sector || ''}
          </div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-ghost btn-sm" onclick="openExportModal()">‚Üó Export</button>
          <button class="btn btn-primary btn-sm" onclick="openPhaseModal(${p.id})">Phase aktualisieren</button>
        </div>
      </div>
      <div class="detail-layout">
        <div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:16px;">Phasenverlauf</div>
          ${phasesHtml}
        </div>
        <div>
          <div class="info-card">
            <div class="info-card-title">Fortschritt</div>
            <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
              <svg width="60" height="60" style="transform:rotate(-90deg);flex-shrink:0;">
                <circle cx="30" cy="30" r="26" fill="none" stroke="var(--bg2)" stroke-width="5"/>
                <circle cx="30" cy="30" r="26" fill="none" stroke="var(--gold)" stroke-width="5"
                  stroke-dasharray="${circ}" stroke-dashoffset="${dash}" stroke-linecap="round"/>
              </svg>
              <div>
                <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;">${prog}%</div>
                <div style="font-size:12px;color:var(--muted);">Phase ${p.phase+1} von 6</div>
              </div>
            </div>
          </div>
          <div class="info-card">
            <div class="info-card-title">Pipeline Status</div>
            <div style="display:inline-flex;align-items:center;gap:8px;background:var(--navy-light);border-radius:8px;padding:8px 14px;margin-bottom:4px;">
              <div style="width:8px;height:8px;border-radius:50%;background:${p.status==='closed'?'var(--green)':'var(--gold)'};"></div>
              <span style="font-weight:700;font-size:13px;color:var(--navy);">${p.dealStatus || (p.status==='closed'?'Deal closed':'Active')}</span>
            </div>
            <div style="margin-top:10px;">
              <div class="detail-row"><span class="dr-label">Sektor</span><span class="dr-val">${p.sector || '‚Äî'}</span></div>
              <div class="detail-row"><span class="dr-label">Region</span><span class="dr-val">${p.region || '‚Äî'}</span></div>
              <div class="detail-row"><span class="dr-label">K√§ufer</span><span class="dr-val">EterniTeam GmbH</span></div>
              <div class="detail-row"><span class="dr-label">Target</span><span class="dr-val">${p.target}</span></div>
            </div>
          </div>
          <div class="info-card">
            <div class="info-card-title">Finanzkennzahlen (Tsd. ‚Ç¨)</div>
            <div class="detail-row"><span class="dr-label">Revenues</span><span class="dr-val">‚Ç¨${(p.revenues||0).toLocaleString('de-DE')}k</span></div>
            <div class="detail-row"><span class="dr-label">EBITDA</span><span class="dr-val">‚Ç¨${(p.ebitda||0).toLocaleString('de-DE')}k</span></div>
            <div class="detail-row"><span class="dr-label">EBIT</span><span class="dr-val">‚Ç¨${(p.ebit||0).toLocaleString('de-DE')}k</span></div>
            <div class="detail-row"><span class="dr-label">EBIT Margin</span><span class="dr-val">${p.ebitMargin?.toFixed(2) || '‚Äî'}%</span></div>
            <div class="detail-row"><span class="dr-label">EV</span><span class="dr-val gold" style="font-size:15px;">‚Ç¨${(p.ev||0).toLocaleString('de-DE')}k</span></div>
            ${p.earnOutPct != null ? `<div class="detail-row"><span class="dr-label">Earn-Out %</span><span class="dr-val">${p.earnOutPct?.toFixed(2)}%</span></div>` : ''}
            ${p.fixedPrice != null ? `<div class="detail-row"><span class="dr-label">Fixed Price (Cash)</span><span class="dr-val">‚Ç¨${(p.fixedPrice||0).toLocaleString('de-DE')}k</span></div>` : ''}
            ${p.equityCash != null ? `<div class="detail-row"><span class="dr-label">Equity Cash Component</span><span class="dr-val">‚Ç¨${(p.equityCash||0).toLocaleString('de-DE')}k</span></div>` : ''}
            <div class="detail-row"><span class="dr-label">EBITDA Multiple</span><span class="dr-val">${p.ebitdaMultiple?.toFixed(2) || '‚Äî'}x</span></div>
            <div class="detail-row"><span class="dr-label">EBIT Multiple</span><span class="dr-val">${p.ebitMultiple?.toFixed(2) || '‚Äî'}x</span></div>
            <div class="detail-row"><span class="dr-label">Projected IRR</span><span class="dr-val" style="color:var(--green);font-family:'DM Mono',monospace;font-size:15px;font-weight:700;">${p.irr != null ? p.irr.toFixed(2)+'%' : '#NUM!'}</span></div>
          </div>
          <div class="info-card">
            <div class="info-card-title">Meilenstein-Daten</div>
            <div class="detail-row"><span class="dr-label">Start Prozess</span><span class="dr-val">${fmtDate(p.start)}</span></div>
            <div class="detail-row"><span class="dr-label">DD Start</span><span class="dr-val">${p.ddStart ? fmtDate(p.ddStart) : '‚Äî'}</span></div>
            <div class="detail-row"><span class="dr-label">DD Ende</span><span class="dr-val">${p.ddEnd ? fmtDate(p.ddEnd) : '‚Äî'}</span></div>
            <div class="detail-row"><span class="dr-label">Zeichnung LOI</span><span class="dr-val" style="color:var(--gold);">${p.loiDate ? fmtDate(p.loiDate) : '‚Äî'}</span></div>
            <div class="detail-row"><span class="dr-label">Signing</span><span class="dr-val" style="color:#d97706;">${p.signingDate ? fmtDate(p.signingDate) : '‚Äî'}</span></div>
            <div class="detail-row"><span class="dr-label">Closing</span><span class="dr-val" style="color:var(--green);">${p.closingDate ? fmtDate(p.closingDate) : '‚Äî'}</span></div>
          </div>
          ${p.desc ? `<div class="info-card"><div class="info-card-title">Dealnotiz</div><div style="font-size:12.5px;color:var(--muted);line-height:1.6;">${p.desc}</div></div>` : ''}
          <div class="info-card">
            <div class="info-card-title">Risikoeinsch√§tzung</div>
            <div class="risk-matrix">${riskHtml}</div>
          </div>
        </div>
      </div>
    </div>`;

  setView('detail');
  document.getElementById('page-title').textContent = p.name;
  document.getElementById('breadcrumb-sub').textContent = 'Projektdetail';
}

function openPhaseModal(id) {
  const p = projects.find(x => x.id === id);
  const opts = PHASES.map((ph,i) => `<option value="${i}" ${i === p.phase ? 'selected' : ''}>Phase ${i+1} ‚Äî ${ph.name}</option>`).join('');
  const statusOpts = ['active','pending','closed'].map(s => `<option value="${s}" ${s === p.status ? 'selected' : ''}>${{active:'Aktiv',pending:'Ausstehend',closed:'Abgeschlossen'}[s]}</option>`).join('');
  const riskOpts = ['low','medium','high'].map(r => `<option value="${r}" ${r === p.risk ? 'selected' : ''}>${{low:'Niedrig',medium:'Mittel',high:'Hoch'}[r]}</option>`).join('');
  document.getElementById('add-modal').innerHTML = `
    <div class="modal-box">
      <div class="modal-title">Deal aktualisieren</div>
      <div class="modal-sub">${p.name} ‚Äî Aktuellen Stand anpassen.</div>
      <div class="form-group"><label class="form-label">Aktuelle Phase</label><select class="form-select" id="upd-phase">${opts}</select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="upd-status">${statusOpts}</select></div>
        <div class="form-group"><label class="form-label">Risiko</label><select class="form-select" id="upd-risk">${riskOpts}</select></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="resetAddModal();closeModal('add-modal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="updateDeal(${id})">Speichern ‚Üí</button>
      </div>
    </div>`;
  document.getElementById('add-modal').classList.add('open');
}

function updateDeal(id) {
  const p = projects.find(x => x.id === id);
  p.phase = parseInt(document.getElementById('upd-phase').value);
  p.status = document.getElementById('upd-status').value;
  p.risk = document.getElementById('upd-risk').value;
  activities.unshift({ user: 'YN', text: `hat <strong>${p.name}</strong> auf Phase ${p.phase+1} aktualisiert`, time: 'Gerade eben' });
  resetAddModal();
  closeModal('add-modal');
  renderAll();
  openDetail(id);
  save();
}

function resetAddModal() {
  document.getElementById('add-modal').innerHTML = getAddModalHTML();
}

function goBack() {
  setView('projects');
  document.getElementById('page-title').textContent = 'Alle Deals';
  document.getElementById('breadcrumb-sub').textContent = 'Deal-√úbersicht';
  document.querySelectorAll('.nav-item')[1].click();
}

// ‚îÄ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ
function addNote() {
  const v = document.getElementById('note-input').value.trim();
  if (!v) return;
  const list = document.getElementById('notes-list');
  const div = document.createElement('div');
  div.className = 'note-item';
  div.innerHTML = `<div class="note-meta">YN ¬∑ Jetzt</div><div class="note-text">${v}</div>`;
  list.insertBefore(div, list.firstChild);
  document.getElementById('note-input').value = '';
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
function selExport(t) {
  selectedExport = t;
  document.querySelectorAll('.export-opt').forEach(el => el.classList.remove('sel'));
  document.getElementById('exp-' + t).classList.add('sel');
}

function runExport() {
  const scope = document.getElementById('exp-scope').value;
  const title = document.getElementById('exp-title').value;
  closeModal('export-modal');
  const list = scope === 'all' ? projects : scope === 'active' ? projects.filter(p => p.status === 'active') : currentDetailId ? [projects.find(p => p.id === currentDetailId)] : projects;

  if (selectedExport === 'csv') {
    exportCSV(list, title);
  } else {
    exportPDF(list, title);
  }
}

function exportCSV(list, title) {
  const rows = [['Projektname','Typ','K√§ufer','Target','Sektor','Volumen (Mio ‚Ç¨)','Status','Phase','Start','Closing','Risiko']];
  list.forEach(p => rows.push([p.name, 'Buyout', 'EterniTeam GmbH', p.target, p.sector||'', p.volume, p.status, `Phase ${p.phase+1} - ${PHASES[p.phase].name}`, p.start, p.end, p.risk]));
  const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'EterniTrack_Export.csv'; a.click();
}

function exportPDF(list, title) {
  const today = new Date().toLocaleDateString('de-DE', { day:'2-digit', month:'long', year:'numeric' });
  const dealsHtml = list.map(p => {
    const prog = Math.round(p.phase/5*100);
    const allTasks = PHASES.flatMap((ph, pi) => ph.tasks.map((t,ti) => ({ done: pi < p.phase || (pi === p.phase && ti < Math.ceil(ph.tasks.length*0.5)), text: t, phase: ph.name })));
    const doneCnt = allTasks.filter(t => t.done).length;
    const riskColor = { low: '#2d7a52', medium: '#c47a2a', high: '#b83a3a' }[p.risk];
    const typeColor = '#1e3557';
    return `
    <div style="background:#fff;border:1px solid #e2ddd3;border-radius:12px;padding:28px;margin-bottom:24px;page-break-inside:avoid;border-top:4px solid ${typeColor};">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;">
        <div>
          <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:26px;font-weight:700;color:#1a1814;margin-bottom:4px;">${p.name}</div>
          <div style="font-size:13px;color:#8a8278;">EterniTeam GmbH ‚Üí ${p.target} ¬∑ ${p.sector || ''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:24px;font-weight:700;color:#1a2f4a;font-family:'DM Mono',monospace;">‚Ç¨${p.volume}M</div>
          <div style="font-size:11px;color:#8a8278;font-family:'DM Mono',monospace;margin-top:2px;">${{active:'‚óè AKTIV',closed:'‚óè CLOSED',pending:'‚óè AUSSTEHEND'}[p.status]}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:18px;background:#f6f5f0;border-radius:8px;padding:14px;">
        <div><div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#8a8278;margin-bottom:4px;font-family:'DM Mono',monospace;">Typ</div><div style="font-size:12px;font-weight:600;color:${typeColor};">BUYOUT</div></div>
        <div><div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#8a8278;margin-bottom:4px;font-family:'DM Mono',monospace;">Fortschritt</div><div style="font-size:12px;font-weight:600;">${prog}% (Ph. ${p.phase+1}/6)</div></div>
        <div><div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#8a8278;margin-bottom:4px;font-family:'DM Mono',monospace;">Closing</div><div style="font-size:12px;font-weight:600;">${fmtDate(p.end)}</div></div>
        <div><div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#8a8278;margin-bottom:4px;font-family:'DM Mono',monospace;">Risiko</div><div style="font-size:12px;font-weight:600;color:${riskColor};">${{low:'NIEDRIG',medium:'MITTEL',high:'HOCH'}[p.risk]}</div></div>
      </div>
      <div style="background:#f6f5f0;border-radius:6px;height:6px;margin-bottom:6px;"><div style="height:100%;width:${prog}%;background:linear-gradient(90deg,#1a2f4a,#8aad7f);border-radius:6px;"></div></div>
      <div style="font-size:11px;color:#8a8278;margin-bottom:18px;font-family:'DM Mono',monospace;">Aktuelle Phase: ${PHASES[p.phase].name} ¬∑ ${doneCnt}/${allTasks.length} Tasks erledigt</div>
      ${p.desc ? `<div style="background:#fdf6e8;border-left:3px solid #b8863a;padding:12px 14px;border-radius:0 8px 8px 0;font-size:12.5px;color:#3d3a34;margin-bottom:18px;line-height:1.5;">${p.desc}</div>` : ''}
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#8a8278;margin-bottom:12px;font-family:'DM Mono',monospace;">Phasen√ºbersicht</div>
      ${PHASES.map((ph,i) => {
        const phDone = i < p.phase; const phCur = i === p.phase;
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f0ece4;">
          <div style="width:24px;height:24px;border-radius:6px;background:${phDone?'#fdf6e8':phCur?'#e8eef7':'#f6f5f0'};display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;">${phDone?'‚úì':ph.icon}</div>
          <div style="flex:1;font-size:12px;font-weight:${phCur?600:400};color:${phDone?'#b8863a':phCur?'#1e3557':'#8a8278'};">Phase ${i+1} ‚Äî ${ph.name}</div>
          <div style="font-size:11px;font-family:'DM Mono',monospace;color:#b5b0a8;">${phDone?'‚úì Abgeschlossen':phCur?'‚ñ∂ In Bearbeitung':'‚óã Ausstehend'}</div>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');

  const html = `<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Manrope:wght@300;400;500;600;700&family=DM+Mono:wght@300;400;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Plus Jakarta Sans',sans-serif;background:#f6f5f0;color:#1a1814;padding:40px;}
  @media print{body{background:white;padding:0;}}

/* ‚îÄ‚îÄ‚îÄ PIPEDRIVE SYNC ‚îÄ‚îÄ‚îÄ */
.pd-status-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 13px;
  font-weight: 500;
}
.pd-connected { background: var(--green-bg); color: var(--green); border: 1px solid rgba(45,122,82,0.2); }
.pd-disconnected { background: var(--bg2); color: var(--muted); border: 1px solid var(--border); }
.pd-error { background: var(--red-bg); color: var(--red); border: 1px solid rgba(184,58,58,0.2); }
.pd-loading { background: var(--navy-light); color: var(--navy); border: 1px solid rgba(30,53,87,0.2); }
.pd-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.pd-dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
.pd-dot-grey { background: var(--muted2); }
.pd-dot-red { background: var(--red); }
.pd-dot-pulse { background: var(--navy); animation: pd-pulse 1s infinite; }
@keyframes pd-pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

.stage-list { display: flex; flex-direction: column; gap: 8px; max-height: 260px; overflow-y: auto; }
.stage-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  cursor: pointer;
  transition: all 0.15s;
  font-size: 13px;
}
.stage-item:hover { border-color: var(--navy); background: var(--navy-light); }
.stage-item.selected { border-color: var(--navy); background: var(--navy-light); }
.stage-checkbox {
  width: 17px; height: 17px;
  border-radius: 5px;
  border: 2px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-size: 10px;
  transition: all 0.15s;
}
.stage-item.selected .stage-checkbox { background: var(--navy); border-color: var(--navy); color: #fff; }
.stage-name { font-weight: 500; flex: 1; }
.stage-count { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; }

.sync-preview {
  background: var(--bg);
  border-radius: 10px;
  padding: 14px;
  margin-top: 16px;
  max-height: 200px;
  overflow-y: auto;
}
.sync-preview-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--muted);
  margin-bottom: 10px;
  font-family: 'DM Mono', monospace;
}
.preview-deal {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12.5px;
}
.preview-deal:last-child { border-bottom: none; }
.preview-deal-name { font-weight: 600; flex: 1; }
.preview-deal-val { color: var(--gold); font-family: 'DM Mono', monospace; font-size: 11px; }
.preview-deal-stage { font-size: 11px; color: var(--muted); }
.preview-new { color: var(--green); font-size: 10px; font-weight: 700; font-family: 'DM Mono', monospace; }
.preview-exists { color: var(--muted2); font-size: 10px; font-family: 'DM Mono', monospace; }

.sync-spinner {
  display: inline-block;
  width: 14px; height: 14px;
  border: 2px solid rgba(30,53,87,0.2);
  border-top-color: var(--navy);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

.pd-last-sync {
  font-size: 11px;
  color: var(--muted2);
  font-family: 'DM Mono', monospace;
  margin-top: 6px;
}

</style></head><body>
<div style="max-width:820px;margin:0 auto;">
  <!-- HEADER -->
  <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:32px;background:#1a2f4a;border-radius:16px;margin-bottom:32px;color:#fff;">
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
        <div style="width:34px;height:34px;background:#8aad7f;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;">‚óÜ</div>
        <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:22px;font-weight:700;">EterniTrack</div>
      </div>
      <div style="font-size:11px;letter-spacing:2px;text-transform:uppercase;color:#8a8278;font-family:'DM Mono',monospace;">EterniTeam GmbH ¬∑ M&A Deal Intelligence</div>
    </div>
    <div style="text-align:right;">
      <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:20px;font-weight:700;color:#8aad7f;">${title}</div>
      <div style="font-size:11px;color:#8a8278;margin-top:4px;font-family:'DM Mono',monospace;">Stand: ${today}</div>
      <div style="font-size:11px;color:#8a8278;font-family:'DM Mono',monospace;">Erstellt von: Yannick</div>
    </div>
  </div>

  <!-- SUMMARY BAR -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px;">
    ${[
      ['Deals',list.length,'Total'],
      ['Aktiv',list.filter(p=>p.status==='active').length,'Deals'],
      ['‚Ç¨'+list.reduce((s,p)=>s+p.volume,0)+'M','Volumen','Kumuliert'],
      [Math.round(list.reduce((s,p)=>s+p.phase/5*100,0)/(list.length||1))+'%','√ò Fortschritt','Alle Deals']
    ].map(([val,lab,sub])=>`
    <div style="background:#fff;border:1px solid #e2ddd3;border-radius:10px;padding:16px;text-align:center;">
      <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:28px;font-weight:700;color:#1a1814;">${val}</div>
      <div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#8a8278;font-family:'DM Mono',monospace;margin-top:4px;">${lab}</div>
      <div style="font-size:11px;color:#b5b0a8;">${sub}</div>
    </div>`).join('')}
  </div>

  ${dealsHtml}

  <!-- FOOTER -->
  <div style="margin-top:32px;padding-top:20px;border-top:1px solid #e2ddd3;display:flex;justify-content:space-between;font-size:11px;color:#b5b0a8;font-family:'DM Mono',monospace;">
    <span>EterniTeam GmbH ¬∑ Vertraulich</span>
    <span>Entwickelt von Yannick ¬∑ EterniTrack</span>
  </div>
</div>
</body></html>`;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 800);
}

// ‚îÄ‚îÄ‚îÄ MODAL / NAV ‚îÄ‚îÄ‚îÄ
function openModal() {
  document.getElementById('add-modal').classList.add('open');
  const t = new Date(), e = new Date(); e.setMonth(e.getMonth()+6);
  document.getElementById('f-start').value = t.toISOString().split('T')[0];
  document.getElementById('f-end').value = e.toISOString().split('T')[0];
}

function getAddModalHTML() { return `<div class="modal-box" style="max-width:680px;">
<div class="modal-title">Neuen Deal anlegen</div>
<div class="modal-sub">Felder mit * sind Pflichtfelder. Finanzielle Angaben in Tsd. ‚Ç¨.</div>

<div style="font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace;margin:16px 0 8px;">Stammdaten</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Codename *</label><input class="form-input" id="f-name" placeholder="z.B. ALPHA"></div>
  <div class="form-group"><label class="form-label">Pipeline-Status *</label>
    <select class="form-select" id="f-dealstatus">
      <option value="IO in preparation">IO in preparation</option>
      <option value="IO sent">IO sent</option>
      <option value="IO negotiation">IO negotiation</option>
      <option value="LOI preparation">LOI preparation</option>
      <option value="LOI sent">LOI sent</option>
      <option value="Deal closed">Deal closed</option>
    </select>
  </div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Sektor</label><input class="form-input" id="f-sector" placeholder="z.B. Floor coating service provider"></div>
  <div class="form-group"><label class="form-label">Region/Bundesland</label><input class="form-input" id="f-region" placeholder="z.B. Bavaria"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Target-Unternehmen *</label><input class="form-input" id="f-target" placeholder="Zielunternehmen GmbH"></div>
  <div class="form-group"><label class="form-label">Risikolevel</label>
    <select class="form-select" id="f-risk"><option value="low">Niedrig</option><option value="medium" selected>Mittel</option><option value="high">Hoch</option></select>
  </div>
</div>

<div style="font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace;margin:16px 0 8px;">Finanzkennzahlen (Tsd. ‚Ç¨)</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Revenues</label><input class="form-input" id="f-revenues" type="number" placeholder="z.B. 4451"></div>
  <div class="form-group"><label class="form-label">EBITDA</label><input class="form-input" id="f-ebitda" type="number" placeholder="z.B. 745"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">EBIT</label><input class="form-input" id="f-ebit" type="number" placeholder="z.B. 727"></div>
  <div class="form-group"><label class="form-label">EBIT Margin (%)</label><input class="form-input" id="f-ebitmargin" type="number" step="0.01" placeholder="z.B. 16.33"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">EV *</label><input class="form-input" id="f-ev" type="number" placeholder="z.B. 2000"></div>
  <div class="form-group"><label class="form-label">Earn-Out (%)</label><input class="form-input" id="f-earnout" type="number" step="0.01" placeholder="z.B. 35"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Fixed Price (Cash Invest)</label><input class="form-input" id="f-fixedprice" type="number" placeholder="z.B. 1300"></div>
  <div class="form-group"><label class="form-label">Equity Cash Component</label><input class="form-input" id="f-equitycash" type="number" placeholder="z.B. 487"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">EBITDA Multiple</label><input class="form-input" id="f-ebitdamul" type="number" step="0.01" placeholder="z.B. 2.68"></div>
  <div class="form-group"><label class="form-label">EBIT Multiple</label><input class="form-input" id="f-ebitmul" type="number" step="0.01" placeholder="z.B. 2.75"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Projected IRR (%)</label><input class="form-input" id="f-irr" type="number" step="0.01" placeholder="z.B. 56.94"></div>
  <div class="form-group"></div>
</div>

<div style="font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace;margin:16px 0 8px;">Meilenstein-Daten</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Start Prozess *</label><input class="form-input" id="f-start" type="date"></div>
  <div class="form-group"><label class="form-label">Ziel-Closing</label><input class="form-input" id="f-end" type="date"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">DD Start</label><input class="form-input" id="f-ddstart" type="date"></div>
  <div class="form-group"><label class="form-label">DD Ende</label><input class="form-input" id="f-ddend" type="date"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Datum Zeichnung LOI</label><input class="form-input" id="f-loidate" type="date"></div>
  <div class="form-group"><label class="form-label">Datum Signing</label><input class="form-input" id="f-signing" type="date"></div>
</div>
<div class="form-row">
  <div class="form-group"><label class="form-label">Datum Closing</label><input class="form-input" id="f-closing" type="date"></div>
  <div class="form-group"><label class="form-label">Aktuelle Phase</label>
    <select class="form-select" id="f-phase">
      <option value="0">Phase 1 ‚Äî Vorbereitung & NDA</option>
      <option value="1">Phase 2 ‚Äî Due Diligence</option>
      <option value="2">Phase 3 ‚Äî Verhandlung & LOI</option>
      <option value="3">Phase 4 ‚Äî Signing</option>
      <option value="4">Phase 5 ‚Äî Regulatory</option>
      <option value="5">Phase 6 ‚Äî Closing</option>
    </select>
  </div>
</div>
<div class="form-group"><label class="form-label">Beschreibung / Dealnotiz</label><textarea class="form-textarea" id="f-desc" placeholder="Kurze Beschreibung des Deals‚Ä¶"></textarea></div>
<div class="modal-footer">
  <button class="btn btn-ghost" onclick="closeModal('add-modal')">Abbrechen</button>
  <button class="btn btn-primary" onclick="addDeal()">Deal anlegen ‚Üí</button>
</div></div>`; }

function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeModalOutside(e, id) { if (e.target.id === id) closeModal(id); }
function openExportModal() { document.getElementById('export-modal').classList.add('open'); }

function addDeal() {
  const name   = document.getElementById('f-name').value.trim();
  const target = document.getElementById('f-target').value.trim();
  const start  = document.getElementById('f-start').value;
  const ev     = parseFloat(document.getElementById('f-ev').value) || 0;
  if (!name || !target || !start) { alert('Bitte Codename, Target und Start-Datum ausf√ºllen.'); return; }
  const dealStatus = document.getElementById('f-dealstatus').value;
  const statusMap  = { 'Deal closed':'closed', 'LOI sent':'active', 'LOI preparation':'active', 'IO negotiation':'active', 'IO sent':'active', 'IO in preparation':'active' };
  const p = {
    id: nextId++, name,
    buyer: 'EterniTeam GmbH', target,
    sector:  document.getElementById('f-sector').value.trim(),
    region:  document.getElementById('f-region').value.trim(),
    revenues: parseFloat(document.getElementById('f-revenues').value) || null,
    ebitda:   parseFloat(document.getElementById('f-ebitda').value)   || null,
    ebit:     parseFloat(document.getElementById('f-ebit').value)     || null,
    ebitMargin: parseFloat(document.getElementById('f-ebitmargin').value) || null,
    ev,
    earnOutPct:  parseFloat(document.getElementById('f-earnout').value)    || null,
    fixedPrice:  parseFloat(document.getElementById('f-fixedprice').value) || null,
    equityCash:  parseFloat(document.getElementById('f-equitycash').value) || null,
    ebitdaMultiple: parseFloat(document.getElementById('f-ebitdamul').value) || null,
    ebitMultiple:   parseFloat(document.getElementById('f-ebitmul').value)   || null,
    irr: document.getElementById('f-irr').value !== '' ? parseFloat(document.getElementById('f-irr').value) : null,
    dealStatus,
    status: statusMap[dealStatus] || 'active',
    phase:  parseInt(document.getElementById('f-phase').value),
    risk:   document.getElementById('f-risk').value,
    start,
    end:         document.getElementById('f-end').value     || null,
    ddStart:     document.getElementById('f-ddstart').value || null,
    ddEnd:       document.getElementById('f-ddend').value   || null,
    loiDate:     document.getElementById('f-loidate').value || null,
    signingDate: document.getElementById('f-signing').value || null,
    closingDate: document.getElementById('f-closing').value || null,
    desc: document.getElementById('f-desc').value.trim(),
  };
  // If no end date set, estimate 12 months from start
  if (!p.end) { const d = new Date(start); d.setFullYear(d.getFullYear()+1); p.end = d.toISOString().split('T')[0]; }
  projects.push(p);
  activities.unshift({ user: 'YN', text: `hat <strong>${p.name}</strong> hinzugef√ºgt`, time: 'Gerade eben' });
  closeModal('add-modal');
  renderAll();
  save();
}

// ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ
function setView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + id).classList.add('active');
}

function switchNav(id, el) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (el) el.classList.add('active');
  setView(id);
  const titles = { dashboard: ['Dashboard','√úbersicht'], projects: ['Alle Deals','Deal-√úbersicht'], overview: ['Gantt-Ansicht','Timeline'], checklist: ['Checklisten','Aufgaben√ºbersicht'] };
  if (titles[id]) {
    document.getElementById('page-title').textContent = titles[id][0];
    document.getElementById('breadcrumb-sub').textContent = titles[id][1];
  }
  if (id === 'overview') renderGantt();
  if (id === 'checklist') renderChecklist();
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function fmtDate(d) {
  return new Date(d).toLocaleDateString('de-DE', { day:'2-digit', month:'short', year:'numeric' });
}
function interpDate(s, e, t) {
  const sd = new Date(s), ed = new Date(e);
  return new Date(sd.getTime() + t * (ed - sd)).toISOString().split('T')[0];
}

// ‚îÄ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ‚îÄ
function save() { try { localStorage.setItem('eternitrack_projects', JSON.stringify(projects)); } catch(e){} }
function load() {
  try {
    const d = localStorage.getItem('eternitrack_projects');
    if (d) { projects = JSON.parse(d); nextId = Math.max(...projects.map(p => p.id)) + 1; }
  } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ BOSS SIMULATION ‚îÄ‚îÄ‚îÄ
setInterval(() => {
  const online = Math.random() > 0.3;
  const dot = document.getElementById('boss-online');
  if (dot) {
    dot.style.background = online ? 'var(--green)' : 'var(--muted2)';
    dot.style.boxShadow = online ? '0 0 0 2px var(--white), 0 0 5px var(--green)' : 'none';
  }
  document.getElementById('collab-indicator').innerHTML = `<div class="cb-dot"></div><span>${online ? '2 Online' : '1 Online'}</span>`;
}, 8000);


// ‚îÄ‚îÄ‚îÄ PIPEDRIVE INTEGRATION ‚îÄ‚îÄ‚îÄ
// NOTE: Pipedrive's API doesn't set CORS headers for browser requests.
// This integration uses a CORS proxy (api.allorigins.win) for demo purposes.
// In production, route requests through your own backend/serverless function.
const PD_PROXY = 'https://api.allorigins.win/raw?url=';
const PD_BASE  = 'https://api.pipedrive.com/v1';

let pdApiKey     = '';
let pdPipelineId = null;
let pdStages     = [];
let pdSelectedStages = new Set();
let pdPreviewDeals = [];

function openPipedriveModal() {
  pdApiKey = localStorage.getItem('pd_apikey') || '';
  document.getElementById('pd-apikey').value = pdApiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
  document.getElementById('pd-modal').classList.add('open');
  if (pdApiKey) { pdConnect(true); }
}

async function pdFetch(path) {
  const url = encodeURIComponent(`${PD_BASE}${path}${path.includes('?')?'&':'?'}api_token=${pdApiKey}`);
  const res  = await fetch(PD_PROXY + url);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

function pdSetStatus(type, text, spinner = false) {
  const bar = document.getElementById('pd-status-bar');
  const txt = document.getElementById('pd-status-text');
  bar.className = 'pd-status-bar pd-' + type;
  const dotClass = { connected:'pd-dot-green', disconnected:'pd-dot-grey', error:'pd-dot-red', loading:'pd-dot-pulse' }[type];
  bar.innerHTML = spinner
    ? `<div class="sync-spinner"></div><span>${text}</span>`
    : `<div class="pd-dot ${dotClass}"></div><span>${text}</span>`;
}

async function pdConnect(silent = false) {
  const input = document.getElementById('pd-apikey').value.trim();
  if (input && input !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') pdApiKey = input;
  if (!pdApiKey) { pdSetStatus('error', 'Bitte API-Key eingeben.'); return; }

  pdSetStatus('loading', 'Verbinde mit Pipedrive‚Ä¶', true);
  try {
    // 1. Verify key
    const me = await pdFetch('/users/me');
    if (!me.success) throw new Error('Ung√ºltiger API-Key');

    // 2. Find "Targets" pipeline
    const pipes = await pdFetch('/pipelines');
    const target = pipes.data?.find(p => p.name.toLowerCase().includes('target'));
    if (!target) throw new Error('Pipeline "Targets" nicht gefunden. Bitte Namen pr√ºfen.');
    pdPipelineId = target.id;

    // 3. Load stages
    const stagesRes = await pdFetch(`/stages?pipeline_id=${pdPipelineId}`);
    pdStages = stagesRes.data || [];

    // 4. Restore saved stage selection
    const saved = JSON.parse(localStorage.getItem('pd_stages') || '[]');
    pdSelectedStages = new Set(saved.length ? saved : []);

    // 5. Save key
    localStorage.setItem('pd_apikey', pdApiKey);
    pdSetStatus('connected', `Verbunden ¬∑ Pipeline: ${target.name} ¬∑ ${pdStages.length} Stages`);

    document.getElementById('pd-step-apikey').style.display = 'none';
    document.getElementById('pd-step-stages').style.display  = 'block';
    document.getElementById('pd-badge').style.display = 'inline';

    renderStages();
    await pdLoadPreview();

    const lastSync = localStorage.getItem('pd_last_sync');
    if (lastSync) document.getElementById('pd-last-sync-text').textContent = 'Letzter Sync: ' + lastSync;

  } catch(e) {
    pdSetStatus('error', 'Fehler: ' + e.message);
  }
}

function pdDisconnect() {
  localStorage.removeItem('pd_apikey');
  localStorage.removeItem('pd_stages');
  pdApiKey = ''; pdPipelineId = null; pdStages = []; pdSelectedStages = new Set(); pdPreviewDeals = [];
  document.getElementById('pd-step-apikey').style.display = 'block';
  document.getElementById('pd-step-stages').style.display  = 'none';
  document.getElementById('pd-preview-area').style.display = 'none';
  document.getElementById('pd-sync-btn').style.display     = 'none';
  document.getElementById('pd-badge').style.display        = 'none';
  document.getElementById('pd-apikey').value = '';
  pdSetStatus('disconnected', 'Nicht verbunden ‚Äî API-Key eingeben');
}

function renderStages() {
  const list = document.getElementById('pd-stage-list');
  if (!pdStages.length) { list.innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">Keine Stages gefunden.</div>'; return; }
  list.innerHTML = pdStages.map(s => {
    const sel = pdSelectedStages.has(s.id);
    return `<div class="stage-item ${sel?'selected':''}" onclick="pdToggleStage(${s.id},this)" data-id="${s.id}">
      <div class="stage-checkbox">${sel?'‚úì':''}</div>
      <div class="stage-name">${s.name}</div>
    </div>`;
  }).join('');
}

async function pdToggleStage(id, el) {
  if (pdSelectedStages.has(id)) { pdSelectedStages.delete(id); el.classList.remove('selected'); el.querySelector('.stage-checkbox').textContent = ''; }
  else { pdSelectedStages.add(id); el.classList.add('selected'); el.querySelector('.stage-checkbox').textContent = '‚úì'; }
  localStorage.setItem('pd_stages', JSON.stringify([...pdSelectedStages]));
  await pdLoadPreview();
}

async function pdLoadPreview() {
  if (!pdSelectedStages.size) {
    document.getElementById('pd-preview-area').style.display = 'none';
    document.getElementById('pd-sync-btn').style.display     = 'none';
    pdPreviewDeals = [];
    return;
  }
  pdSetStatus('loading', 'Deals werden geladen‚Ä¶', true);
  try {
    // Fetch deals for each selected stage
    const allDeals = [];
    for (const stageId of pdSelectedStages) {
      const res = await pdFetch(`/deals?stage_id=${stageId}&pipeline_id=${pdPipelineId}&status=open&limit=50`);
      if (res.data) allDeals.push(...res.data);
    }
    pdPreviewDeals = allDeals;

    // Render preview
    const previewList = document.getElementById('pd-preview-list');
    const existingNames = new Set(projects.map(p => p.target.toLowerCase()));
    document.getElementById('pd-preview-count').textContent = allDeals.length;

    if (!allDeals.length) {
      previewList.innerHTML = '<div style="color:var(--muted);font-size:13px;">Keine offenen Deals in diesen Stages gefunden.</div>';
    } else {
      previewList.innerHTML = allDeals.map(d => {
        const val = d.value ? `‚Ç¨${Math.round(d.value/1000000*10)/10}M` : '‚Äî';
        const stageName = pdStages.find(s => s.id === d.stage_id)?.name || '';
        const isNew = !existingNames.has((d.title||'').toLowerCase());
        return `<div class="preview-deal">
          <div class="preview-deal-name">${d.title || 'Unbenannt'}</div>
          <div class="preview-deal-stage">${stageName}</div>
          <div class="preview-deal-val">${val}</div>
          <div class="${isNew?'preview-new':'preview-exists'}">${isNew?'NEU':'bereits importiert'}</div>
        </div>`;
      }).join('');
    }

    document.getElementById('pd-preview-area').style.display = 'block';
    document.getElementById('pd-sync-btn').style.display     = allDeals.length ? 'inline-flex' : 'none';
    document.getElementById('pd-sync-label').textContent = `${allDeals.length} Deals importieren ‚Üí`;

    const stageName = pdStages.find(s => pdSelectedStages.has(s.id))?.name || '';
    pdSetStatus('connected', `Verbunden ¬∑ ${allDeals.length} Deals in ${pdSelectedStages.size} Stage(s) gefunden`);
  } catch(e) {
    pdSetStatus('error', 'Fehler beim Laden: ' + e.message);
  }
}

async function pdRunSync() {
  if (!pdPreviewDeals.length) return;
  const btn = document.getElementById('pd-sync-btn');
  btn.innerHTML = '<div class="sync-spinner"></div>&nbsp;Wird importiert‚Ä¶';
  btn.disabled = true;

  const existingNames = new Set(projects.map(p => p.target.toLowerCase()));
  let imported = 0;
  const today = new Date().toISOString().split('T')[0];

  for (const d of pdPreviewDeals) {
    if (existingNames.has((d.title||'').toLowerCase())) continue; // skip dupes

    const closeDate = d.expected_close_date || (() => { const e=new Date(); e.setMonth(e.getMonth()+9); return e.toISOString().split('T')[0]; })();
    const addDate   = d.add_time ? d.add_time.split(' ')[0] : today;
    const volume    = d.value ? Math.round(d.value / 1000000) || 1 : 0;

    // Map Pipedrive stage order to EterniTrack phase
    const stageObj  = pdStages.find(s => s.id === d.stage_id);
    const stageIdx  = stageObj ? pdStages.findIndex(s => s.id === d.stage_id) : 0;
    const totalPD   = pdStages.length;
    const phase     = Math.min(5, Math.round((stageIdx / Math.max(totalPD-1,1)) * 5));

    projects.push({
      id: nextId++,
      name: 'Projekt ' + (d.title || 'Unbekannt').split(' ').pop(),
      buyer: 'EterniTeam GmbH',
      target: d.title || 'Unbekannt',
      sector: d.category_name || 'Sonstiges',
      start: addDate,
      end: closeDate,
      volume,
      status: 'active',
      phase,
      risk: 'medium',
      desc: `Aus Pipedrive importiert ¬∑ Stage: ${stageObj?.name || '‚Äî'} ¬∑ Deal-ID: ${d.id}`,
      pdId: d.id,
    });
    imported++;
  }

  save();
  renderAll();

  const now = new Date().toLocaleString('de-DE');
  localStorage.setItem('pd_last_sync', now);
  document.getElementById('pd-last-sync-text').textContent = 'Letzter Sync: ' + now;

  activities.unshift({ user:'YN', text:`hat <strong>${imported} Deal${imported!==1?'s':''}</strong> aus Pipedrive importiert`, time:'Gerade eben' });
  renderActivities();

  btn.innerHTML = `‚úì ${imported} Deal${imported!==1?'s':''} importiert`;
  btn.style.background = 'var(--green)';
  pdSetStatus('connected', `Sync abgeschlossen ¬∑ ${imported} neue Deal${imported!==1?'s':''} importiert`);
  setTimeout(() => { btn.disabled = false; btn.innerHTML = 'Erneut synchen ‚Üí'; btn.style.background = ''; }, 3000);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
load();
renderAll();
</script>
</body>
</html>
